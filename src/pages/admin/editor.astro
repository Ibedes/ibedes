---
import fs from "node:fs/promises";
import path from "node:path";
import matter from "gray-matter";
import Layout from "../../layouts/Layout.astro";
import { loadAffiliateProducts } from "../../lib/affiliates";
import { GLOBAL } from "../../lib/variables";
import { formatRupiah } from "../../lib/utils";

export const prerender = false;

const { searchParams } = Astro.url;
const filename = searchParams.get("file");

interface Frontmatter {
    title: string;
    description: string;
    pubDate: string | Date;
    affiliateProducts: string[];
    affiliateContext: string;
    category?: string;
    featuredImage?: string;
    [key: string]: any;
}

let content = "";
let frontmatter: Frontmatter = {
    title: "",
    description: "",
    pubDate: new Date().toISOString().split("T")[0],
    affiliateProducts: [],
    affiliateContext: "",
    category: "",
};

if (filename) {
    try {
        const filePath = path.join(process.cwd(), "src/pages/blog", filename);
        const fileContent = await fs.readFile(filePath, "utf-8");
        const parsed = matter(fileContent);
        content = parsed.content;
        frontmatter = { ...frontmatter, ...parsed.data };
        // Handle date format if it's a Date object
        if (frontmatter.pubDate instanceof Date) {
            frontmatter.pubDate = frontmatter.pubDate
                .toISOString()
                .split("T")[0];
        }
    } catch (e) {
        console.error("Error reading file", e);
    }
}

const allProducts = await loadAffiliateProducts();
const sortedProducts = [...allProducts].reverse();
---

<Layout title={`Editor - ${GLOBAL.username}`}>
    <div class="editor-shell">
        <header class="editor-header">
            <div class="editor-header__text">
                <p class="editor-eyebrow">
                    {filename ? "Mode edit" : "Mode draft"}
                </p>
                <h1>{filename ? "Perbarui artikel" : "Artikel baru"}</h1>
                <p>
                    Kelola markdown, metadata, dan afiliasi dari satu layar yang
                    lebih ringkas.
                </p>
            </div>
            <div class="editor-header__actions">
                <a href="/admin" class="editor-button editor-button--ghost">
                    <i class="fa-solid fa-arrow-left-long" aria-hidden="true"
                    ></i>
                    <span>Kembali</span>
                </a>
                <a
                    id="view-article-btn"
                    href="#"
                    target="_blank"
                    data-hidden
                    class="editor-button editor-button--soft"
                >
                    <i class="fa-solid fa-eye" aria-hidden="true"></i>
                    <span>Lihat</span>
                </a>
                <button
                    id="save-btn"
                    type="button"
                    class="editor-button editor-button--primary"
                >
                    <i class="fa-solid fa-save" aria-hidden="true"></i>
                    <span>Simpan</span>
                </button>
            </div>
        </header>

        <div class="editor-chip-row">
            <span class="editor-chip" data-filename-chip>
                <i class="fa-regular fa-file-lines" aria-hidden="true"></i>
                <span data-filename-chip-text
                    >{filename || "Belum ada file"}</span
                >
            </span>
            <span class="editor-chip">
                <i class="fa-regular fa-calendar" aria-hidden="true"></i>
                {
                    frontmatter.pubDate
                        ? new Date(frontmatter.pubDate).toLocaleDateString(
                              "id-ID",
                          )
                        : "Tanggal otomatis"
                }
            </span>
            <span class="editor-chip">
                <i class="fa-solid fa-tags" aria-hidden="true"></i>
                <span data-product-count
                    >{frontmatter.affiliateProducts?.length ?? 0}</span
                >
                produk
            </span>
        </div>

        <div class="editor-grid">
            <section class="editor-panel editor-panel--primary">
                <div class="editor-panel__head">
                    <div>
                        <p class="editor-eyebrow">Konten</p>
                        <h2>Markdown editor</h2>
                    </div>
                    <span class="editor-hint">
                        Gunakan Markdown standar Â· Cmd/Ctrl + S untuk simpan
                        cepat
                    </span>
                </div>
                <textarea
                    id="content-editor"
                    class="editor-textarea"
                    placeholder="Tulis artikel di sini...">{content}</textarea
                >
            </section>

            <aside class="editor-stack">
                <div class="editor-card">
                    <div class="editor-card__head">
                        <div>
                            <p class="editor-eyebrow">Metadata</p>
                            <h3>Detail artikel</h3>
                        </div>
                        <span class="editor-pill">
                            {filename ? "Existing" : "Draft"}
                        </span>
                    </div>

                    <div class="editor-field">
                        <label for="filename-input" class="editor-label"
                            >Nama file</label
                        >
                        <input
                            type="text"
                            id="filename-input"
                            value={filename || ""}
                            disabled={!!filename}
                            class="editor-input"
                            placeholder="contoh: kisah-hujan.md"
                        />
                        <p class="editor-hint">
                            Gunakan huruf kecil dan strip untuk pemisah kata.
                        </p>
                    </div>

                    <div class="editor-field">
                        <label for="title-input" class="editor-label"
                            >Judul</label
                        >
                        <input
                            type="text"
                            id="title-input"
                            value={frontmatter.title}
                            class="editor-input"
                            placeholder="Judul utama"
                        />
                    </div>

                    <div class="editor-field">
                        <label for="desc-input" class="editor-label"
                            >Deskripsi</label
                        >
                        <textarea
                            id="desc-input"
                            rows="3"
                            class="editor-textarea editor-textarea--small"
                            placeholder="Ringkasan singkat"
                            >{frontmatter.description}</textarea
                        >
                    </div>

                    <div class="editor-field">
                        <label for="date-input" class="editor-label"
                            >Tanggal</label
                        >
                        <input
                            type="date"
                            id="date-input"
                            value={frontmatter.pubDate instanceof Date
                                ? frontmatter.pubDate
                                      .toISOString()
                                      .split("T")[0]
                                : frontmatter.pubDate}
                            class="editor-input"
                        />
                    </div>

                    <div class="editor-field">
                        <label for="category-input" class="editor-label"
                            >Kategori artikel</label
                        >
                        <input
                            type="text"
                            id="category-input"
                            value={frontmatter.category || ""}
                            class="editor-input"
                            placeholder="contoh: parenting, produktivitas"
                        />
                        <p class="editor-hint">
                            Dipakai untuk metadata dan saran produk yang lebih
                            relevan.
                        </p>
                    </div>
                </div>

                <div class="editor-card">
                    <div class="editor-card__head">
                        <div>
                            <p class="editor-eyebrow">Media</p>
                            <h3>Gambar unggulan</h3>
                        </div>
                        <span class="editor-pill">Opsional</span>
                    </div>

                    <div class="editor-field">
                        <label for="image-input" class="editor-label"
                            >URL gambar</label
                        >
                        <div class="editor-input-group">
                            <input
                                type="url"
                                id="image-input"
                                value={frontmatter.featuredImage || ""}
                                placeholder="https://..."
                                class="editor-input"
                            />
                            <label class="editor-upload" title="Unggah gambar">
                                <input
                                    type="file"
                                    id="file-upload"
                                    accept="image/*"
                                />
                                <i class="fa-solid fa-upload" aria-hidden="true"
                                ></i>
                            </label>
                        </div>
                    </div>

                    <div id="image-preview" class="editor-preview hidden">
                        <img src="" alt="Preview" loading="lazy" />
                    </div>

                    <div class="editor-field">
                        <label for="image-alt-input" class="editor-label"
                            >Alt text</label
                        >
                        <input
                            type="text"
                            id="image-alt-input"
                            value={frontmatter.featuredImageAlt || ""}
                            class="editor-input"
                            placeholder="Deskripsi untuk aksesibilitas"
                        />
                    </div>

                    <div class="editor-field">
                        <label for="image-caption-input" class="editor-label"
                            >Caption / kredit</label
                        >
                        <input
                            type="text"
                            id="image-caption-input"
                            value={frontmatter.featuredImageCaption || ""}
                            class="editor-input"
                            placeholder="Foto oleh ..."
                        />
                    </div>
                </div>

                <div class="editor-card">
                    <div class="editor-card__head">
                        <div>
                            <p class="editor-eyebrow">Afiliasi</p>
                            <h3>Produk tertaut</h3>
                        </div>
                        <span class="editor-pill">
                            {frontmatter.affiliateProducts?.length ?? 0} dipilih
                        </span>
                    </div>

                    <div class="editor-field">
                        <div class="editor-field">
                            <label for="affiliate-context" class="editor-label"
                                >Catatan konteks</label
                            >
                            <input
                                type="text"
                                id="affiliate-context"
                                value={frontmatter.affiliateContext || ""}
                                class="editor-input"
                                placeholder="Contoh: Produk rekomendasi"
                            />
                        </div>

                        {
                            sortedProducts.length > 0 ? (
                                <>
                                    <div class="editor-field">
                                        <label
                                            for="product-search"
                                            class="editor-label"
                                        >
                                            Cari produk
                                        </label>
                                        <input
                                            type="search"
                                            id="product-search"
                                            class="editor-input"
                                            placeholder="Cari nama, ID, kategori, atau tag"
                                            autocomplete="off"
                                        />
                                        <p class="editor-hint">
                                            Daftar diurut berdasarkan produk
                                            terbaru. Cari manual atau pilih dari
                                            saran di atas.
                                        </p>
                                    </div>

                                    <div
                                        class="editor-checkbox-list custom-scrollbar"
                                        data-product-picker
                                    >
                                        {sortedProducts.map((product) => (
                                            <label
                                                class:list={{
                                                    "editor-checkbox-item": true,
                                                    "editor-checkbox-item--verified":
                                                        product.verified,
                                                    "editor-checkbox-item--suggested": false,
                                                }}
                                                data-product-option
                                                data-category={
                                                    product.category ?? ""
                                                }
                                                data-verified={
                                                    product.verified
                                                        ? "true"
                                                        : "false"
                                                }
                                                data-product-keywords={[
                                                    product.name,
                                                    product.id,
                                                    product.category ?? "",
                                                    ...(product.tags ?? []),
                                                ]
                                                    .join(" ")
                                                    .toLowerCase()}
                                            >
                                                <input
                                                    type="checkbox"
                                                    name="affiliate-products"
                                                    value={product.id}
                                                    checked={
                                                        frontmatter.affiliateProducts &&
                                                        frontmatter.affiliateProducts.includes(
                                                            product.id,
                                                        )
                                                    }
                                                />
                                                <div class="editor-checkbox-copy">
                                                    <div class="editor-product-info">
                                                        <span class="editor-product-name">
                                                            {product.name}
                                                        </span>
                                                        <div class="editor-product-meta">
                                                            <span class="editor-product-platform">
                                                                <i class="fa-solid fa-store" />
                                                                {
                                                                    product.platform
                                                                }
                                                            </span>
                                                            <span class="editor-product-price">
                                                                {formatRupiah(
                                                                    product.price,
                                                                )}
                                                            </span>
                                                            {product.verified && (
                                                                <span class="editor-verified-badge">
                                                                    <i class="fa-solid fa-check-circle" />
                                                                    Verified
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        ))}
                                    </div>
                                    <p
                                        class="editor-empty hidden"
                                        data-product-search-empty
                                    >
                                        Tidak ada produk yang cocok dengan
                                        pencarianmu.
                                    </p>
                                </>
                            ) : (
                                <p class="editor-empty">
                                    Belum ada produk afiliasi yang tersedia.
                                </p>
                            )
                        }
                    </div>
                </div>
            </aside>
        </div>

        <script
            define:vars={{
                initialFilename: filename,
                initialFrontmatter: frontmatter,
                productIndexData: sortedProducts.map((p) => ({
                    id: p.id,
                    name: p.name,
                    category: p.category ?? "",
                    tags: p.tags ?? [],
                    platform: p.platform,
                    verified: !!p.verified,
                })),
            }}
        >
            // Handle file upload
            const fileInput = document.getElementById("file-upload");
            const urlInput = document.getElementById("image-input");
            const imagePreview = document.getElementById("image-preview");
            const previewImg = imagePreview?.querySelector("img");
            const viewBtn = document.getElementById("view-article-btn");
            const filenameInput = document.getElementById("filename-input");
            const filenameChipText = document.querySelector(
                "[data-filename-chip-text]",
            );
            const productCountChip = document.querySelector(
                "[data-product-count]",
            );
            const affiliatePill = document.querySelector(
                ".editor-card .editor-pill",
            );
            const productCheckboxes = Array.from(
                document.querySelectorAll('input[name="affiliate-products"]'),
            );
            const productSearchInput =
                document.getElementById("product-search");
            const productOptions = Array.from(
                document.querySelectorAll("[data-product-option]"),
            );
            const productPicker = document.querySelector(
                "[data-product-picker]",
            );
            const productSearchEmpty = document.querySelector(
                "[data-product-search-empty]",
            );
            const suggestionContainer = document.querySelector(
                "[data-product-suggestions]",
            );
            const titleInput = document.getElementById("title-input");
            const descInput = document.getElementById("desc-input");
            const contentInput = document.getElementById("content-editor");
            const categoryInput = document.getElementById("category-input");
            const productIndex =
                typeof productIndexData !== "undefined"
                    ? productIndexData
                    : null;

            const optionOrder = productOptions.map((opt, idx) => ({
                opt,
                idx,
            }));

            let currentFilename = initialFilename ?? "";

            function syncViewButton(target) {
                if (!viewBtn) return;
                if (target) {
                    const articleSlug = target.replace(/\.md$/, "");
                    viewBtn.href = `/blog/${articleSlug}`;
                    viewBtn.removeAttribute("data-hidden");
                } else {
                    viewBtn.setAttribute("data-hidden", "true");
                }
            }

            // Show View Article button if editing existing article
            if (currentFilename) {
                syncViewButton(currentFilename);
            }

            function updateFilenameState(newFilename) {
                currentFilename = newFilename;
                if (filenameInput) {
                    filenameInput.value = newFilename;
                    filenameInput.disabled = true;
                }
                if (filenameChipText) {
                    filenameChipText.textContent = newFilename;
                }
                syncViewButton(newFilename);
            }

            function getSelectedProductIds() {
                return productCheckboxes
                    .filter((cb) => cb.checked)
                    .map((cb) => cb.value);
            }

            function updateProductCountDisplay(
                count = getSelectedProductIds().length,
            ) {
                if (productCountChip) {
                    productCountChip.textContent = String(count);
                }
                if (affiliatePill) {
                    affiliatePill.textContent = `${count} dipilih`;
                }
            }

            productCheckboxes.forEach((checkbox) => {
                checkbox.addEventListener("change", () => {
                    updateProductCountDisplay();
                });
            });

            updateProductCountDisplay();

            function filterProductOptions() {
                if (!productOptions.length) return;
                const term =
                    productSearchInput?.value.trim().toLowerCase() ?? "";
                let visibleCount = 0;
                productOptions.forEach((option) => {
                    const keywords = option.dataset.productKeywords || "";
                    const isVisible = !term || keywords.includes(term);
                    option.classList.toggle("hidden", !isVisible);
                    if (isVisible) {
                        visibleCount += 1;
                    }
                });
                if (productSearchEmpty) {
                    productSearchEmpty.classList.toggle(
                        "hidden",
                        visibleCount > 0,
                    );
                }
            }

            productSearchInput?.addEventListener("input", filterProductOptions);
            filterProductOptions();

            const restoreOptionOrder = () => {
                if (!productPicker) return;

                optionOrder
                    .sort((a, b) => a.idx - b.idx)
                    .forEach(({ opt }) => {
                        opt.classList.remove(
                            "editor-checkbox-item--suggestion",
                        );
                        opt.classList.remove("hidden-suggestion");
                        productPicker.appendChild(opt);
                    });
            };

            // --- Enhanced Affiliate suggestions ---
            const tokenize = (text = "") =>
                text
                    .toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, " ")
                    .split(/\s+/)
                    .filter((w) => w.length > 2);

            const computeSuggestions = () => {
                if (!productOptions.length) return;
                try {
                    const title = titleInput?.value || "";
                    const desc = descInput?.value || "";
                    const body = contentInput?.value || "";
                    const category = categoryInput?.value || "";
                    const terms = new Set([
                        ...tokenize(title),
                        ...tokenize(desc),
                        ...tokenize(body.slice(0, 800)), // cukup 800 karakter awal
                        ...tokenize(category),
                    ]);

                    if (!terms.size) {
                        // fallback minimal supaya saran tetap muncul
                        terms.add("default");
                    }

                    const sourceList =
                        productIndex ??
                        productOptions.map((opt) => {
                            const input = opt.querySelector("input");
                            return {
                                id: input?.value || "",
                                name:
                                    opt
                                        .querySelector("span")
                                        ?.textContent?.trim() || "",
                                category: opt.dataset.category || "",
                                tags: (opt.dataset.productKeywords || "")
                                    .split(/\s+/)
                                    .filter(Boolean),
                                platform: opt.textContent || "",
                                verified:
                                    opt.dataset.verified === "true" ||
                                    opt.classList.contains(
                                        "editor-checkbox-item--verified",
                                    ),
                            };
                        });

                    const scores = sourceList
                        .map((p) => {
                            const productTokens = new Set([
                                ...tokenize(p.name),
                                ...tokenize(p.category || ""),
                                ...(p.tags || []).map((t) => t.toLowerCase()),
                            ]);
                            const productText =
                                `${p.name} ${p.category || ""} ${(p.tags || []).join(" ")}`.toLowerCase();
                            let score = 0;
                            terms.forEach((term) => {
                                if (productTokens.has(term)) score += 1;
                                else if (
                                    term.length > 3 &&
                                    productText.includes(term)
                                )
                                    score += 0.6; // partial match
                            });
                            if (p.verified) score += 0.5;
                            return { product: p, score };
                        })
                        .filter((item) => item.score > 0)
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 2);

                    // Reset list to original order, then pin suggestions on top
                    restoreOptionOrder();

                    let finalScores = scores;

                    finalScores.forEach(({ product }) => {
                        const option = productOptions.find(
                            (opt) =>
                                opt.querySelector("input")?.value ===
                                product.id,
                        );
                        if (!option || !productPicker) return;

                        option.classList.add(
                            "editor-checkbox-item--suggestion",
                        );
                        productPicker.insertBefore(
                            option,
                            productPicker.firstChild,
                        );
                    });

                    // Render suggestions by moving products to top of the list (already handled above)
                } catch (err) {
                    console.error("Affiliate suggestion error", err);
                }
            };

            const debouncedCompute = (() => {
                let t;
                return () => {
                    clearTimeout(t);
                    t = setTimeout(computeSuggestions, 250);
                };
            })();

            [titleInput, descInput, contentInput, categoryInput].forEach(
                (el) => {
                    el?.addEventListener("input", debouncedCompute);
                },
            );
            computeSuggestions();

            function updatePreview() {
                const url = urlInput.value.trim();
                if (url && imagePreview && previewImg) {
                    previewImg.src = url;
                    imagePreview.classList.remove("hidden");
                } else if (imagePreview) {
                    imagePreview.classList.add("hidden");
                }
            }

            urlInput?.addEventListener("input", updatePreview);
            // Initial check
            updatePreview();

            fileInput?.addEventListener("change", async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                const formData = new FormData();
                formData.append("file", file);

                // Show loading state
                const uploadBtn = fileInput.parentElement;
                const originalContent = uploadBtn?.innerHTML;
                if (uploadBtn) {
                    uploadBtn.innerHTML =
                        '<i class="fa-solid fa-spinner fa-spin"></i>';
                    uploadBtn.style.pointerEvents = "none";
                }

                try {
                    const response = await fetch("/api/admin/upload", {
                        method: "POST",
                        body: formData,
                    });

                    const result = await response.json();

                    if (response.ok) {
                        urlInput.value = result.url;
                        updatePreview();
                        alert("Image uploaded successfully!");
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error("Upload error:", error);
                    alert(error.message || "Failed to upload image");
                } finally {
                    // Restore button state
                    if (uploadBtn && originalContent) {
                        uploadBtn.innerHTML = originalContent;
                        uploadBtn.style.pointerEvents = "auto";
                    }
                    // Clear input
                    fileInput.value = "";
                }
            });

            const saveBtn = document.getElementById("save-btn");

            saveBtn.addEventListener("click", async () => {
                let filename = filenameInput?.value.trim() ?? "";

                if (!filename) {
                    alert("Please enter a filename");
                    return;
                }

                if (!filename.endsWith(".md")) {
                    filename += ".md";
                    if (filenameInput) {
                        filenameInput.value = filename;
                    }
                }

                const title = document.getElementById("title-input").value;
                const description = document.getElementById("desc-input").value;
                const pubDate = document.getElementById("date-input").value;
                const category =
                    document.getElementById("category-input").value;
                const featuredImage =
                    document.getElementById("image-input").value;
                const featuredImageAlt =
                    document.getElementById("image-alt-input").value;
                const featuredImageCaption = document.getElementById(
                    "image-caption-input",
                ).value;
                const affiliateContext =
                    document.getElementById("affiliate-context").value;
                const contentBody =
                    document.getElementById("content-editor").value;

                // Get selected products
                const selectedProducts = getSelectedProductIds();

                // Construct Frontmatter
                const escapeYaml = (str) => str.replace(/"/g, '\\"');

                // Start with existing frontmatter to preserve other fields (like layout, tags, etc)
                // We exclude the fields we are explicitly handling to avoid duplicates
                const {
                    title: _title,
                    description: _description,
                    pubDate: _pubDate,
                    featuredImage: _featuredImage,
                    featuredImageAlt: _featuredImageAlt,
                    featuredImageCaption: _featuredImageCaption,
                    affiliateProducts: _affiliateProducts,
                    affiliateContext: _affiliateContext,
                    category: _category,
                    ...preservedFrontmatter
                } = initialFrontmatter;

                // Ensure layout is present if it wasn't there
                if (!preservedFrontmatter.layout) {
                    preservedFrontmatter.layout =
                        "../../layouts/BlogLayout.astro";
                }

                const frontmatterLines = ["---"];

                // Add preserved fields
                for (const [key, value] of Object.entries(
                    preservedFrontmatter,
                )) {
                    if (Array.isArray(value)) {
                        frontmatterLines.push(`${key}:`);
                        value.forEach((item) =>
                            frontmatterLines.push(`  - "${item}"`),
                        );
                    } else if (typeof value === "object" && value !== null) {
                        frontmatterLines.push(`${key}:`);
                        for (const [k, v] of Object.entries(value)) {
                            frontmatterLines.push(`  ${k}: "${v}"`);
                        }
                    } else {
                        frontmatterLines.push(
                            `${key}: ${JSON.stringify(value)}`,
                        );
                    }
                }

                // Add explicitly managed fields
                frontmatterLines.push(`title: "${escapeYaml(title)}"`);
                frontmatterLines.push(
                    `description: "${escapeYaml(description)}"`,
                );
                frontmatterLines.push(`pubDate: "${pubDate}"`);

                if (category) {
                    frontmatterLines.push(
                        `category: "${escapeYaml(category)}"`,
                    );
                }

                if (featuredImage) {
                    frontmatterLines.push(
                        `featuredImage: "${escapeYaml(featuredImage)}"`,
                    );
                }

                if (featuredImageAlt) {
                    frontmatterLines.push(
                        `featuredImageAlt: "${escapeYaml(featuredImageAlt)}"`,
                    );
                }

                if (featuredImageCaption) {
                    frontmatterLines.push(
                        `featuredImageCaption: "${escapeYaml(featuredImageCaption)}"`,
                    );
                }

                if (selectedProducts.length > 0) {
                    frontmatterLines.push("affiliateProducts:");
                    selectedProducts.forEach((id) => {
                        frontmatterLines.push(`  - "${id}"`);
                    });
                }

                if (affiliateContext) {
                    frontmatterLines.push(
                        `affiliateContext: "${escapeYaml(affiliateContext)}"`,
                    );
                }

                frontmatterLines.push("---");
                frontmatterLines.push("");
                frontmatterLines.push(contentBody);

                const fullContent = frontmatterLines.join("\n");

                try {
                    saveBtn.innerHTML =
                        '<i class="fa-solid fa-spinner fa-spin"></i> Menyimpan...';
                    saveBtn.disabled = true;

                    const response = await fetch("/api/admin/save", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            filename,
                            content: fullContent,
                        }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Show success alert
                        alert("Article saved successfully!");

                        // Show View Article button
                        const viewBtn =
                            document.getElementById("view-article-btn");
                        const articleSlug = filename.replace(".md", "");
                        const articleUrl = `/blog/${articleSlug}`;

                        if (viewBtn) {
                            viewBtn.href = articleUrl;
                            viewBtn.removeAttribute("data-hidden");
                        }

                        updateFilenameState(filename);
                        updateProductCountDisplay(selectedProducts.length);

                        saveBtn.classList.add("is-success");
                        saveBtn.innerHTML =
                            '<i class="fa-solid fa-check"></i> Tersimpan';

                        setTimeout(() => {
                            saveBtn.classList.remove("is-success");
                            saveBtn.innerHTML =
                                '<i class="fa-solid fa-save"></i> Simpan';
                            saveBtn.disabled = false;
                        }, 1600);
                    } else {
                        alert("Error saving: " + result.error);
                        saveBtn.innerHTML =
                            '<i class="fa-solid fa-save"></i> Simpan';
                        saveBtn.disabled = false;
                    }
                } catch (e) {
                    console.error(e);
                    // Show error alert
                    alert("Failed to save article");
                    saveBtn.innerHTML =
                        '<i class="fa-solid fa-save"></i> Simpan';
                    saveBtn.disabled = false;
                }
            });
        </script>

        <style>
            .editor-shell {
                max-width: 1100px;
                margin: 0 auto;
                padding: 1.5rem 1.25rem 4rem;
                --editor-border: 1px solid
                    color-mix(in srgb, var(--color-foreground) 14%, transparent);
                --editor-card-bg: color-mix(
                    in srgb,
                    var(--color-card) 92%,
                    transparent
                );
                --editor-radius: 1rem;

                /* Local variables for suggestions */
                --panel: var(--editor-card-bg);
                --accent: #3b82f6;
                --accent-rgb: 59, 130, 246;
            }

            .editor-header {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                padding: 1.25rem;
                border: var(--editor-border);
                border-radius: var(--editor-radius);
                background: var(--editor-card-bg);
            }

            @media (min-width: 768px) {
                .editor-header {
                    flex-direction: row;
                    align-items: flex-start;
                    justify-content: space-between;
                }
            }

            .editor-header__text h1 {
                font-family: var(--font-display);
                font-size: clamp(1.4rem, 3vw, 1.9rem);
                margin: 0;
            }

            .editor-header__text p {
                margin: 0.35rem 0 0;
                max-width: 48ch;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 70%,
                    transparent
                );
            }

            .editor-header__actions {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .editor-eyebrow {
                font-size: 0.7rem;
                letter-spacing: 0.16em;
                text-transform: uppercase;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 55%,
                    transparent
                );
                margin: 0 0 0.2rem 0;
            }

            .editor-button {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.35rem;
                border-radius: 0.85rem;
                padding: 0.6rem 1.1rem;
                border: var(--editor-border);
                font-family: var(--font-mono);
                font-size: 0.9rem;
                cursor: pointer;
                background: transparent;
                color: inherit;
                transition:
                    transform 150ms ease,
                    border-color 150ms ease,
                    background-color 150ms ease;
            }

            .editor-button[data-hidden] {
                display: none !important;
            }

            .editor-button--ghost {
                background: transparent;
            }

            .editor-button--soft {
                background: color-mix(
                    in srgb,
                    var(--color-foreground) 4%,
                    transparent
                );
            }

            .editor-button--primary {
                background: var(--color-primary);
                border-color: color-mix(
                    in srgb,
                    var(--color-primary) 60%,
                    transparent
                );
                color: var(--color-background);
            }

            .editor-button.is-success {
                background: color-mix(
                    in srgb,
                    var(--color-primary) 20%,
                    var(--color-success, #0f9d58)
                );
                border-color: color-mix(
                    in srgb,
                    var(--color-primary) 50%,
                    transparent
                );
            }

            .editor-button:hover,
            .editor-button:focus-visible {
                transform: translateY(-1px);
            }

            .editor-chip-row {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin: 1rem 0 1.25rem;
            }

            .editor-chip {
                display: inline-flex;
                align-items: center;
                gap: 0.35rem;
                padding: 0.4rem 0.9rem;
                border-radius: 999px;
                border: var(--editor-border);
                font-size: 0.8rem;
                text-transform: uppercase;
                letter-spacing: 0.08em;
            }

            .editor-grid {
                display: grid;
                grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
                gap: 1.25rem;
            }

            @media (max-width: 1024px) {
                .editor-grid {
                    grid-template-columns: 1fr;
                }
            }

            .editor-panel {
                border: var(--editor-border);
                border-radius: var(--editor-radius);
                background: var(--editor-card-bg);
                padding: 1rem;
            }

            .editor-panel__head {
                display: flex;
                justify-content: space-between;
                gap: 0.5rem;
                align-items: center;
                flex-wrap: wrap;
                margin-bottom: 0.75rem;
            }

            .editor-hint {
                font-size: 0.8rem;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 60%,
                    transparent
                );
            }

            .editor-textarea {
                width: 100%;
                min-height: 60vh;
                border-radius: 0.9rem;
                border: var(--editor-border);
                background: transparent;
                padding: 0.85rem 1rem;
                font-family: var(--font-mono);
                font-size: 0.95rem;
                resize: vertical;
                line-height: 1.55;
            }

            .editor-textarea--small {
                min-height: 90px;
            }

            .editor-stack {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .editor-card {
                border: var(--editor-border);
                border-radius: var(--editor-radius);
                background: var(--editor-card-bg);
                padding: 1rem;
                display: flex;
                flex-direction: column;
                gap: 0.85rem;
            }

            .editor-card__head {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 0.5rem;
            }

            .editor-card__head h3 {
                margin: 0;
                font-size: 1rem;
            }

            .editor-pill {
                font-size: 0.75rem;
                padding: 0.15rem 0.6rem;
                border-radius: 999px;
                border: var(--editor-border);
            }

            .editor-field {
                display: flex;
                flex-direction: column;
                gap: 0.35rem;
            }

            .editor-label {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.12em;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 60%,
                    transparent
                );
            }

            .editor-input,
            .editor-input-group input {
                border: var(--editor-border);
                border-radius: 0.8rem;
                background: transparent;
                padding: 0.65rem 0.9rem;
                font-family: var(--font-mono);
                font-size: 0.9rem;
                width: 100%;
            }

            .editor-input:disabled {
                opacity: 0.65;
            }

            .editor-input-group {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }

            .editor-upload {
                width: 2.6rem;
                height: 2.6rem;
                border-radius: 0.8rem;
                border: var(--editor-border);
                display: grid;
                place-items: center;
                cursor: pointer;
            }

            .editor-upload input {
                display: none;
            }

            .editor-preview {
                border-radius: 0.85rem;
                border: var(--editor-border);
                padding: 0.2rem;
                background: color-mix(
                    in srgb,
                    var(--color-background) 95%,
                    transparent
                );
            }

            .editor-preview img {
                width: 100%;
                height: auto;
                border-radius: 0.7rem;
                object-fit: cover;
            }

            .editor-checkbox-list {
                max-height: 320px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                padding-right: 0.25rem;
            }

            .editor-checkbox-item {
                display: flex;
                gap: 0.6rem;
                border: var(--editor-border);
                border-radius: 0.8rem;
                padding: 0.65rem 0.75rem;
                align-items: flex-start;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
            }

            .editor-checkbox-item input {
                margin-top: 0.2rem;
            }

            .editor-suggestion-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 0.5rem;
            }

            .editor-suggestion {
                border: 1px solid var(--border-color);
                background: var(--panel);
                border-radius: 10px;
                padding: 0.65rem 0.75rem;
                text-align: left;
                cursor: pointer;
                display: grid;
                gap: 0.25rem;
                transition:
                    border-color 0.15s ease,
                    box-shadow 0.15s ease;
            }

            .editor-suggestion:hover {
                border-color: var(--accent);
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            }

            .editor-suggestion--active {
                border-color: var(--accent);
                background: color-mix(in srgb, var(--accent) 12%, var(--panel));
            }

            .editor-suggestion__name {
                font-weight: 600;
                line-height: 1.3;
            }

            .editor-suggestion__meta {
                font-size: 0.85rem;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 65%,
                    transparent
                );
            }

            .editor-suggestion__score {
                font-size: 0.75rem;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 55%,
                    transparent
                );
            }

            /* Enhanced Product Suggestion Styles */
            .editor-suggestions-header {
                background: linear-gradient(
                    135deg,
                    color-mix(in srgb, var(--accent) 15%, transparent) 0%,
                    color-mix(in srgb, var(--accent) 5%, transparent) 100%
                );
                border: 1px solid
                    color-mix(in srgb, var(--accent) 30%, transparent);
                border-radius: 0.8rem;
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }

            .editor-suggestions-title {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.9rem;
                font-weight: 600;
                color: color-mix(
                    in srgb,
                    var(--accent) 80%,
                    var(--color-foreground)
                );
                margin: 0 0 0.25rem 0;
            }

            .editor-suggestions-subtitle {
                font-size: 0.75rem;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 70%,
                    transparent
                );
                margin: 0;
            }

            .editor-checkbox-copy {
                flex: 1;
                min-width: 0;
            }

            .editor-checkbox-item--suggestion {
                border: 2px solid var(--accent) !important;
                box-shadow: 0 4px 16px
                    rgba(var(--accent-rgb, 59, 130, 246), 0.15) !important;
                background: linear-gradient(
                    135deg,
                    color-mix(in srgb, var(--accent) 8%, var(--panel)) 0%,
                    color-mix(in srgb, var(--accent) 3%, var(--panel)) 100%
                ) !important;
                animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .editor-checkbox-item--suggestion::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(
                    90deg,
                    var(--accent),
                    color-mix(in srgb, var(--accent) 60%, transparent)
                );
            }

            .editor-checkbox-item--suggestion::after {
                content: "ð¡";
                position: absolute;
                top: 0.65rem;
                right: 0.75rem;
                font-size: 1rem;
                opacity: 0.7;
                animation: pulse 2s ease-in-out infinite;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 0.7;
                    transform: scale(1);
                }
                50% {
                    opacity: 1;
                    transform: scale(1.1);
                }
            }

            .editor-product-info {
                display: flex;
                flex-direction: column;
                gap: 0.2rem;
                width: 100%;
                min-width: 0;
            }

            .editor-product-name {
                font-weight: 600;
                line-height: 1.35;
                color: inherit;
                font-size: 0.9rem;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .editor-product-meta {
                display: flex;
                align-items: center;
                gap: 0.4rem;
                flex-wrap: wrap;
                font-size: 0.75rem;
            }

            .editor-product-platform {
                display: flex;
                align-items: center;
                gap: 0.25rem;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 70%,
                    transparent
                );
            }

            .editor-product-price {
                font-weight: 600;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 90%,
                    transparent
                );
            }

            .editor-verified-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                background: color-mix(
                    in srgb,
                    var(--color-success, #10b981) 15%,
                    transparent
                );
                color: var(--color-success, #10b981);
                padding: 0.1rem 0.4rem;
                border-radius: 0.4rem;
                font-size: 0.7rem;
                font-weight: 500;
                border: 1px solid
                    color-mix(
                        in srgb,
                        var(--color-success, #10b981) 30%,
                        transparent
                    );
            }

            .editor-empty {
                font-size: 0.9rem;
                color: color-mix(
                    in srgb,
                    var(--color-foreground) 65%,
                    transparent
                );
                text-align: center;
                padding: 1rem 0;
            }

            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: color-mix(
                    in srgb,
                    var(--color-foreground) 25%,
                    transparent
                );
                border-radius: 999px;
            }

            .hidden {
                display: none !important;
            }
        </style>
    </div>
</Layout>
