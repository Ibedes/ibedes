---
import Layout from "../../layouts/Layout.astro";
import fs from "node:fs/promises";
import path from "node:path";
import { GLOBAL } from "../../lib/variables";

export const prerender = false;

const metadataPath = path.join(process.cwd(), "src/data/custom-pages.json");
let savedPages: Array<{ slug: string; title: string; path: string; updatedAt?: string }> = [];

try {
    const raw = await fs.readFile(metadataPath, "utf-8");
    savedPages = JSON.parse(raw);
} catch (error) {
    const errMsg = (error as any)?.message || error;
    console.warn("[Page Builder] metadata belum ditemukan, akan dibuat saat publish", errMsg);
}

savedPages.sort((a, b) => {
    const aTime = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
    const bTime = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
    return bTime - aTime;
});

---

<Layout title={`Page Builder - ${GLOBAL.username}`}>
    <div class="builder-workspace">
        <!-- Header -->
        <header class="workspace-header">
            <div class="header-content">
                <div class="header-info">
                    <div class="breadcrumb">
                        <span class="breadcrumb-item">Dashboard</span>
                        <span class="breadcrumb-separator">â†’</span>
                        <span class="breadcrumb-item breadcrumb-active">Page Builder</span>
                    </div>
                    <h1 class="page-title">
                        <span class="title-icon">ðŸŽ¨</span>
                        Page Builder
                    </h1>
                    <p class="page-subtitle">
                        Rancang halaman kustom tanpa build ulang: tulis HTML/CSS/JS, cek pratinjau, dan terbitkan instan.
                    </p>
                </div>
                <div class="header-actions">
                    <a class="action-btn action-btn-secondary" href="/admin/dashboard">
                        <i class="fa-solid fa-arrow-left-long"></i>
                        Dashboard
                    </a>
                    <button class="action-btn action-btn-primary" id="publish-btn">
                        <i class="fa-solid fa-rocket"></i>
                        Terbitkan
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Workspace -->
        <div class="workspace-content">
            <aside class="side-panel">
                <div class="panel-section">
                    <div class="section-header">
                        <h3><i class="fa-solid fa-cog"></i> Pengaturan Halaman</h3>
                    </div>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label for="slug-input">URL Halaman</label>
                            <div class="input-group">
                                <span class="input-prefix">/custom/</span>
                                <input
                                    id="slug-input"
                                    type="text"
                                    placeholder="my-awesome-page"
                                    class="form-input"
                                    autocomplete="off"
                                />
                            </div>
                            <small class="input-hint">URL akhir: <span data-url-preview>/custom/my-awesome-page</span></small>
                        </div>
                        <div class="form-group">
                            <label for="title-input">Judul Halaman</label>
                            <input
                                id="title-input"
                                type="text"
                                placeholder="Masukkan judul halaman..."
                                class="form-input"
                                data-live-field
                            />
                            <small class="input-hint">Muncul di tab browser dan hasil pencarian</small>
                        </div>
                        <div class="form-group">
                            <label for="description-input">Deskripsi Halaman</label>
                            <textarea
                                id="description-input"
                                placeholder="Deskripsi singkat untuk SEO dan sosial media..."
                                class="form-input"
                                rows="3"
                            ></textarea>
                        </div>
                    </div>
                </div>

            </aside>

            <div class="editor-panel">
                <div class="panel-section">
                    <div class="section-header">
                        <h3><i class="fa-solid fa-code"></i> Editor & Pratinjau</h3>
                        <div class="editor-tabs" role="tablist">
                            <button class="editor-tab active" data-lang="html">
                                <i class="fa-solid fa-code"></i>
                                HTML
                            </button>
                            <button class="editor-tab" data-lang="css">
                                <i class="fa-solid fa-palette"></i>
                                CSS
                            </button>
                            <button class="editor-tab" data-lang="javascript">
                                <i class="fa-solid fa-js"></i>
                                JavaScript
                            </button>
                            <button class="editor-tab" data-lang="preview">
                                <i class="fa-solid fa-eye"></i>
                                Pratinjau
                            </button>
                        </div>
                    </div>

                    <div class="editor-body">
                        <div class="editor-container" id="code-editor-container">
                            <div id="code-editor" class="monaco-editor"></div>
                            <textarea id="html-input" class="hidden-editor" spellcheck="false" data-live-field></textarea>
                            <textarea id="css-input" class="hidden-editor" spellcheck="false" data-live-field></textarea>
                            <textarea id="js-input" class="hidden-editor" spellcheck="false" data-live-field></textarea>
                        </div>

                        <div class="preview-inline" id="preview-inline" hidden>
                            <div class="preview-inline__header">
                                <div>
                                    <p class="preview-inline__eyebrow">Pratinjau</p>
                                    <h4 class="preview-inline__title" data-preview-title>Untitled Page</h4>
                                    <p class="preview-inline__url" data-preview-url>/custom/your-page</p>
                                </div>
                        <div class="preview-inline__controls">
                            <div class="device-selector">
                                <button class="device-btn active" data-device="desktop">
                                    <i class="fa-solid fa-desktop"></i>
                                    Desktop
                                </button>
                                <button class="device-btn" data-device="tablet">
                                    <i class="fa-solid fa-tablet-screen-button"></i>
                                    Tablet
                                </button>
                                <button class="device-btn" data-device="mobile">
                                    <i class="fa-solid fa-mobile-screen"></i>
                                    Mobile
                                </button>
                                <button class="device-btn device-btn--link" id="preview-new-tab-btn">
                                    <i class="fa-solid fa-up-right-from-square"></i>
                                </button>
                            </div>
                        </div>
                            </div>
                            <div class="preview-inline__frame">
                                <iframe
                                    id="preview-frame"
                                    class="preview-frame"
                                    title="Page Preview"
                                    sandbox="allow-scripts allow-same-origin allow-forms"
                                ></iframe>
                            </div>
                        </div>
                    </div>

                    <div class="editor-actions">
                        <button class="action-btn action-btn-secondary" id="format-code-btn">
                            <i class="fa-solid fa-magic-wand-sparkles"></i>
                            Format Code
                        </button>
                        <button class="action-btn action-btn-secondary" id="validate-code-btn">
                            <i class="fa-solid fa-check-circle"></i>
                            Validate
                        </button>
                        <div class="editor-status" data-status>
                            <i class="fa-solid fa-circle-info"></i>
                            Ready to code
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saved Pages Section -->
        <div class="saved-pages-section">
            <div class="section-header">
                <div class="header-info">
                    <h3><i class="fa-solid fa-folder"></i> Halaman Terbit</h3>
                    <p>Kelola halaman kustom yang sudah dipublikasikan</p>
                </div>
                <div class="section-actions">
                    <button class="action-btn action-btn-secondary" onclick="window.location.reload()">
                        <i class="fa-solid fa-rotate"></i>
                        Refresh
                    </button>
                </div>
            </div>
            
            {savedPages.length === 0 ? (
                <div class="empty-state">
                    <div class="empty-icon">ðŸ“„</div>
                    <h4>Belum ada halaman</h4>
                    <p>Buat halaman kustom pertama langsung dari editor di atas</p>
                </div>
            ) : (
                <div class="pages-grid">
                    {savedPages.map((page) => (
                        <div class="page-card">
                            <div class="page-header">
                                <h4 class="page-title">{page.title || page.slug}</h4>
                                <div class="page-status">
                                    <span class="status-badge status-published">
                                        <i class="fa-solid fa-check-circle"></i>
                                        Terbit
                                    </span>
                                </div>
                            </div>
                            <div class="page-meta">
                                <div class="meta-item">
                                    <i class="fa-solid fa-link"></i>
                                    <span>{page.path || `/custom/${page.slug}`}</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fa-solid fa-clock"></i>
                                    <span>{page.updatedAt ? new Date(page.updatedAt).toLocaleString("id-ID") : "Just now"}</span>
                                </div>
                            </div>
                            <div class="page-actions">
                                <a
                                    href={page.publicPath || `/custom-pages/${page.slug}.html`}
                                    target="_blank"
                                    class="action-btn action-btn-primary action-btn-sm"
                                >
                                    <i class="fa-solid fa-eye"></i>
                                    Lihat
                                </a>
                                <button
                                    class="action-btn action-btn-secondary action-btn-sm"
                                    data-copy-url={page.publicPath || `/custom-pages/${page.slug}.html`}
                                >
                                    <i class="fa-solid fa-copy"></i>
                                    Salin URL
                                </button>
                                <button
                                    class="action-btn action-btn-secondary action-btn-sm"
                                    data-edit-page={page.slug}
                                >
                                    <i class="fa-solid fa-pen-to-square"></i>
                                    Edit
                                </button>
                                <button
                                    class="action-btn action-btn-danger action-btn-sm"
                                    data-delete-page={page.slug}
                                >
                                    <i class="fa-solid fa-trash"></i>
                                    Hapus
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    </div>

    <script>
        // @ts-nocheck
        class PageBuilder {
            constructor() {
                this.initializeElements();
                this.initializeEditor();
                this.initializeEventListeners();
                this.loadInitialState();
            }

            initializeElements() {
                // Form elements
                this.slugInput = document.getElementById('slug-input');
                this.titleInput = document.getElementById('title-input');
                this.descriptionInput = document.getElementById('description-input');
                this.htmlInput = document.getElementById('html-input');
                this.cssInput = document.getElementById('css-input');
                this.jsInput = document.getElementById('js-input');
                
                // Preview elements
                this.previewFrame = document.getElementById('preview-frame');
                this.previewTitle = document.querySelector('[data-preview-title]');
                this.previewUrl = document.querySelector('[data-preview-url]');
                this.urlPreview = document.querySelector('[data-url-preview]');
                
                // Action buttons
                this.publishBtn = document.getElementById('publish-btn');
                this.previewNewTabBtn = document.getElementById('preview-new-tab-btn');
                this.formatCodeBtn = document.getElementById('format-code-btn');
                this.validateCodeBtn = document.getElementById('validate-code-btn');
                
                // Editor elements
                this.editorTabs = document.querySelectorAll('.editor-tab');
                this.deviceBtns = document.querySelectorAll('.device-btn');
                this.statusEl = document.querySelector('[data-status]');
                
                // State
                this.currentLang = 'html';
                this.currentDevice = 'desktop';
                this.previewTimers = new WeakMap();
                this.codeState = {
                    html: '',
                    css: '',
                    javascript: ''
                };
            }

            initializeEditor() {
                this.setupMonacoEditor();
            }

            setupMonacoEditor() {
                const loaderScript = document.createElement('script');
                loaderScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.0/min/vs/loader.min.js';
                document.head.appendChild(loaderScript);

                loaderScript.onload = () => {
                    window.require.config({
                        paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.0/min/vs' }
                    });
                    
                    window.require(['vs/editor/editor.main'], () => {
                        this.monacoEditor = monaco.editor.create(document.getElementById('code-editor'), {
                            value: this.codeState.html,
                            language: 'html',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: false },
                            fontLigatures: true,
                            fontFamily: "'Fira Code', 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace",
                            fontSize: 14,
                            lineNumbers: 'on',
                            roundedSelection: false,
                            scrollBeyondLastLine: false,
                            readOnly: false,
                            cursorStyle: 'line',
                            wordWrap: 'on',
                            folding: true,
                            foldingHighlight: true,
                            showFoldingControls: 'always',
                            bracketPairColorization: { enabled: true },
                            guides: {
                                bracketPairs: true,
                                indentation: true
                            }
                        });

                        this.monacoEditor.onDidChangeModelContent(() => {
                            this.handleCodeChange();
                        });

                        this.syncToFields();
                        this.updatePreview();
                    });
                };
            }

            initializeEventListeners() {
                // Form inputs
                this.slugInput?.addEventListener('input', () => this.handleSlugChange());
                this.titleInput?.addEventListener('input', () => this.handleTitleChange());
                
                // Live field updates
                document.querySelectorAll('[data-live-field]').forEach(field => {
                    field.addEventListener('input', () => this.handleLiveFieldChange(field));
                });

                // Editor tabs
                this.editorTabs.forEach(btn => {
                    btn.addEventListener('click', () => this.switchEditorTab(btn.dataset.lang));
                });

                // Device selector
                this.deviceBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.changeDevice(btn.dataset.device));
                });

                // Action buttons
                this.publishBtn?.addEventListener('click', () => this.publishPage());
                this.previewNewTabBtn?.addEventListener('click', () => this.openPreviewNewTab());
                this.formatCodeBtn?.addEventListener('click', () => this.formatCode());
                this.validateCodeBtn?.addEventListener('click', () => this.validateCode());

                // Copy URL buttons
                document.querySelectorAll('[data-copy-url]').forEach(btn => {
                    btn.addEventListener('click', () => this.copyToClipboard(btn.dataset.copyUrl));
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
            }

            loadInitialState() {
                // Set default content
                this.codeState.html = '<div class="welcome-message">\n  <h1>Welcome to Page Builder!</h1>\n  <p>Mulai dengan menulis HTML, CSS, atau JavaScript kamu sendiri.</p>\n</div>';
                this.codeState.css = '.welcome-message {\n  text-align: center;\n  padding: 4rem 2rem;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: white;\n  border-radius: 1rem;\n  margin: 2rem;\n}\n\n.welcome-message h1 {\n  font-size: 2.5rem;\n  margin-bottom: 1rem;\n}\n\n.welcome-message p {\n  font-size: 1.2rem;\n  opacity: 0.9;\n}';
                this.codeState.javascript = 'console.log("Page Builder initialized!");';

                this.syncToFields();
                this.updatePreview();
            }

            handleCodeChange() {
                if (!this.monacoEditor) return;
                
                this.codeState[this.currentLang] = this.monacoEditor.getValue();
                this.syncToFields();
                
                // Debounced preview update
                const existing = this.previewTimers.get(this.previewFrame);
                if (existing) clearTimeout(existing);
                const timer = setTimeout(() => this.updatePreview(), 300);
                this.previewTimers.set(this.previewFrame, timer);
                
                this.updateStatus('Code updated');
            }

            syncToFields() {
                this.htmlInput.value = this.codeState.html;
                this.cssInput.value = this.codeState.css;
                this.jsInput.value = this.codeState.javascript;
            }

            syncEditorFromState() {
                if (!this.monacoEditor) return;
                const model = monaco.editor.createModel(
                    this.codeState[this.currentLang] || '',
                    this.currentLang === 'javascript' ? 'javascript' : this.currentLang
                );
                this.monacoEditor.setModel(model);
            }

            setCodeState(next) {
                this.codeState = { ...this.codeState, ...next };
                this.syncToFields();
                this.currentLang = 'html';
                if (this.monacoEditor) {
                    this.monacoEditor.setValue(this.codeState.html || '');
                }
            }

            switchEditorTab(lang) {
                if (!window.monaco || !this.monacoEditor) return;
                
                // Update active tab
                this.editorTabs.forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-lang="${lang}"]`).classList.add('active');

                if (lang === 'preview') {
                    this.showPreviewMode();
                    this.updatePreview();
                    return;
                }

                // Save current content
                this.codeState[this.currentLang] = this.monacoEditor.getValue();
                this.currentLang = lang;
                
                // Switch Monaco language
                const model = monaco.editor.createModel(
                    this.codeState[lang] || '',
                    lang === 'javascript' ? 'javascript' : lang
                );
                
                this.monacoEditor.setModel(model);
                this.showEditorMode();
            }

            showEditorMode() {
                document.getElementById('code-editor-container').style.display = 'block';
                document.getElementById('preview-inline').hidden = true;
            }

            showPreviewMode() {
                document.getElementById('code-editor-container').style.display = 'none';
                document.getElementById('preview-inline').hidden = false;
            }

            changeDevice(device) {
                this.currentDevice = device;
                
                // Update device buttons
                this.deviceBtns.forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-device="${device}"]`).classList.add('active');
                
                // Update preview frame size
                const frame = this.previewFrame;
                const container = frame.parentElement;
                
                switch (device) {
                    case 'mobile':
                        frame.style.width = '375px';
                        frame.style.height = '667px';
                        container.style.alignItems = 'flex-start';
                        break;
                    case 'tablet':
                        frame.style.width = '768px';
                        frame.style.height = '1024px';
                        container.style.alignItems = 'flex-start';
                        break;
                    default:
                        frame.style.width = '100%';
                        frame.style.height = '';
                        container.style.alignItems = 'stretch';
                }
                
                this.updateStatus(`Switched to ${device} view`);
            }

            handleSlugChange() {
                const normalized = this.normalizeSlug(this.slugInput.value);
                if (this.slugInput.value !== normalized) {
                    this.slugInput.value = normalized;
                }
                
                const url = normalized ? `/custom/${normalized}` : '/custom/your-page';
                this.previewUrl.textContent = url;
                this.urlPreview.textContent = url;
            }

            handleTitleChange() {
                const title = this.titleInput.value || 'Untitled Page';
                this.previewTitle.textContent = title;
            }

            handleLiveFieldChange(field) {
                if (field === this.titleInput) {
                    this.handleTitleChange();
                }
                if (field === this.slugInput) {
                    this.handleSlugChange();
                }
            }

            normalizeSlug(value) {
                return (value || '')
                    .toLowerCase()
                    .replace(/[^a-z0-9-]/g, '-')
                    .replace(/--+/g, '-')
                    .replace(/^-|-$/g, '');
            }

            escapeScript(value = '') {
                return value.replace(/<\/script/gi, '<\\/script');
            }

            buildDocument() {
                const html = this.htmlInput.value || '<div style="padding:2rem;text-align:center;color:#475569">Add some HTML to get started.</div>';
                const css = this.cssInput.value || 'body{font-family:system-ui;background:#0f172a;color:#e2e8f0;}';
                const js = this.escapeScript(this.jsInput.value || '');
                
                const title = this.titleInput.value || 'Custom Page';
                const description = this.descriptionInput.value || '';
                
                return `<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>${title}</title>
    <meta name="description" content="${description}" />
    <style>
        * { box-sizing: border-box; }
        ${css}
    </style>
</head>
<body>
    ${html}
    <script>
        ${js}
    <\\/script>
</body>
</html>`;
            }

            updatePreview() {
                this.previewFrame.srcdoc = this.buildDocument();
                this.updateStatus('Preview updated');
            }

            openPreviewNewTab() {
                const blob = new Blob([this.buildDocument()], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank', 'noopener,noreferrer');
                setTimeout(() => URL.revokeObjectURL(url), 30000);
                this.updateStatus('Preview opened in new tab');
            }

            async publishPage() {
                const slug = this.normalizeSlug(this.slugInput.value);
                const payload = {
                    slug,
                    title: this.titleInput.value,
                    description: this.descriptionInput.value,
                    html: this.htmlInput.value,
                    css: this.cssInput.value,
                    js: this.jsInput.value
                };

                if (!slug) {
                    this.updateStatus('Please enter a page URL', 'error');
                    this.slugInput.focus();
                    return;
                }

                if (!payload.html.trim() && !payload.css.trim() && !payload.js.trim()) {
                    this.updateStatus('Please add some content (HTML, CSS, or JS)', 'error');
                    this.htmlInput.focus();
                    return;
                }

                this.setBusyState(true, 'Publishing page...');
                
                try {
                    const response = await fetch('/api/admin/save-page', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to publish page');
                    }

                    const targetUrl = result.staticPath || result.path;
                    this.updateStatus(`Page published successfully! ${targetUrl}`, 'success');
                    
                    if (targetUrl) {
                        this.previewUrl.textContent = targetUrl;
                        this.urlPreview.textContent = targetUrl;
                    }

                    setTimeout(() => window.location.reload(), 1500);
                } catch (error) {
                    console.error(error);
                    this.updateStatus(error.message || 'Failed to publish page', 'error');
                } finally {
                    this.setBusyState(false);
                }
            }

            formatCode() {
                if (!this.monacoEditor) return;
                
                // Simple formatting for different languages
                const actions = [
                    { id: 'editor.action.formatDocument', label: 'Format Document' },
                    { id: 'editor.action.formatSelection', label: 'Format Selection' }
                ];
                
                this.monacoEditor.trigger('keyboard', actions[0].id, {});
                this.updateStatus('Code formatted');
            }

            validateCode() {
                // Basic validation
                const html = this.htmlInput.value;
                const css = this.cssInput.value;
                const js = this.jsInput.value;
                
                const errors = [];
                
                if (!html.trim()) {
                    errors.push('HTML content is empty');
                }
                
                if (!css.trim()) {
                    errors.push('CSS content is empty');
                }
                
                // Check for common JS errors
                if (js.trim()) {
                    try {
                        new Function(js);
                    } catch (e) {
                        errors.push(`JavaScript error: ${e.message}`);
                    }
                }
                
                if (errors.length === 0) {
                    this.updateStatus('Code validation passed', 'success');
                } else {
                    this.updateStatus(`Validation errors: ${errors.join(', ')}`, 'error');
                }
            }

            copyToClipboard(text) {
                if (!text) return;
                
                navigator.clipboard?.writeText(text).then(() => {
                    this.updateStatus(`Copied: ${text}`, 'success');
                }).catch(() => {
                    this.updateStatus('Failed to copy to clipboard', 'error');
                });
            }

            handleKeyboardShortcuts(e) {
                // Ctrl+S or Cmd+S to save draft
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    this.saveDraft();
                }
                
                // Ctrl+P or Cmd+P to publish
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    this.publishPage();
                }
                
                // Ctrl+1,2,3 to switch tabs
                if ((e.ctrlKey || e.metaKey) && ['1', '2', '3'].includes(e.key)) {
                    e.preventDefault();
                    const lang = ['html', 'css', 'javascript'][parseInt(e.key) - 1];
                    this.switchEditorTab(lang);
                }
            }

            setBusyState(isBusy, message = '') {
                this.publishBtn.disabled = isBusy;
                this.publishBtn.innerHTML = isBusy 
                    ? '<i class="fa-solid fa-spinner fa-spin"></i> ' + (message || 'Processing...')
                    : '<i class="fa-solid fa-rocket"></i> Publish';
            }

            updateStatus(message, type = 'info') {
                const statusEl = document.querySelector('[data-status]');
                if (!statusEl) return;
                
                const iconMap = {
                    info: 'fa-circle-info',
                    success: 'fa-circle-check',
                    error: 'fa-circle-exclamation',
                    warning: 'fa-triangle-exclamation'
                };
                
                statusEl.innerHTML = `<i class="fa-solid ${iconMap[type]}"></i> ${message}`;
                statusEl.className = `editor-status ${type}`;
                
                // Auto-hide after 3 seconds for success messages
                if (type === 'success') {
                    setTimeout(() => {
                        statusEl.innerHTML = '<i class="fa-solid fa-circle-info"></i> Ready to code';
                        statusEl.className = 'editor-status';
                    }, 3000);
                }
            }
        }

        // Initialize the page builder when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const builder = new PageBuilder();
            window.pageBuilder = builder;

            // Edit existing page
            document.querySelectorAll('[data-edit-page]').forEach((btn) => {
                btn.addEventListener('click', async () => {
                    const button = btn as HTMLButtonElement;
                    const slug = button.dataset.editPage;
                    if (!slug) return;
                    button.disabled = true;
                    const original = button.innerHTML;
                    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                    try {
                        const res = await fetch(`/api/admin/load-page?slug=${slug}`);
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Gagal memuat halaman');

                        builder.slugInput.value = data.slug || slug;
                        builder.titleInput.value = data.title || slug;
                        builder.handleSlugChange();
                        builder.handleTitleChange();
                        builder.setCodeState({
                            html: data.html || '',
                            css: data.css || '',
                            javascript: data.js || ''
                        });
                        builder.updatePreview();
                        builder.updateStatus(`Memuat halaman "${slug}"`, 'success');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } catch (err: any) {
                        await window.adminAlert?.(err?.message || 'Gagal memuat halaman');
                    } finally {
                        button.disabled = false;
                        button.innerHTML = original;
                    }
                });
            });

            // Delete existing page
            document.querySelectorAll('[data-delete-page]').forEach((btn) => {
                btn.addEventListener('click', async () => {
                    const button = btn as HTMLButtonElement;
                    const slug = button.dataset.deletePage;
                    if (!slug) return;

                    const ok = await window.adminConfirm?.(
                        `Hapus halaman "${slug}"? Tindakan tidak dapat dibatalkan.`,
                        'Hapus halaman',
                        'Hapus',
                        'Batal'
                    );
                    if (!ok) return;

                    button.disabled = true;
                    const original = button.innerHTML;
                    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                    try {
                        const res = await fetch('/api/admin/delete-page', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ slug })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Gagal menghapus halaman');

                        const card = button.closest('.page-card');
                        card?.remove();
                        builder.updateStatus(`Halaman "${slug}" dihapus`, 'success');
                    } catch (err: any) {
                        await window.adminAlert?.(err?.message || 'Gagal menghapus halaman');
                        button.disabled = false;
                        button.innerHTML = original;
                    }
                });
            });
        });
    </script>

    <style>
        .builder-workspace {
            --builder-primary: var(--color-primary);
            --builder-primary-strong: color-mix(
                in srgb,
                var(--color-primary) 78%,
                transparent
            );
            --builder-surface: color-mix(
                in srgb,
                var(--color-card) 95%,
                transparent
            );
            --builder-surface-alt: color-mix(
                in srgb,
                var(--color-card) 98%,
                transparent
            );
            --builder-subtle: color-mix(
                in srgb,
                var(--color-foreground) 6%,
                transparent
            );
            --builder-border-color: color-mix(
                in srgb,
                var(--color-foreground) 14%,
                transparent
            );
            --builder-shadow: 0 14px 42px
                color-mix(in srgb, var(--color-foreground) 11%, transparent);
            --builder-radius: calc(var(--radius) + 6px);
            --builder-radius-sm: calc(var(--radius) + 2px);
            --builder-radius-lg: calc(var(--radius) + 12px);
            --builder-code-bg: color-mix(
                in srgb,
                var(--color-foreground) 5%,
                transparent
            );
            --builder-muted: color-mix(
                in srgb,
                var(--color-foreground) 65%,
                transparent
            );
            --builder-success: color-mix(in srgb, #16a34a 92%, transparent);
            --builder-warning: color-mix(in srgb, #f59e0b 92%, transparent);
            --builder-error: color-mix(in srgb, #ef4444 92%, transparent);
            min-height: 100vh;
            width: min(1500px, 100%);
            margin: 0 auto;
            padding: 1.25rem 1rem 3.25rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            color: var(--color-foreground);
            font-family: var(--font-mono);
        }

        .builder-workspace * {
            box-sizing: border-box;
        }

        @media (min-width: 1024px) {
            .builder-workspace {
                width: min(1500px, 100%);
                margin-left: auto;
                margin-right: auto;
            }
        }

        .workspace-header,
        .editor-panel,
        .preview-panel,
        .saved-pages-section {
            background: var(--builder-surface);
            border: 1px solid var(--builder-border-color);
            border-radius: var(--builder-radius-lg);
            box-shadow: var(--builder-shadow);
        }

        .workspace-header {
            padding: 1.35rem 1.5rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1.25rem;
        }

        .header-info {
            flex: 1;
            display: grid;
            gap: 0.35rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            margin: 0;
            font-size: 0.82rem;
            color: var(--builder-muted);
        }

        .breadcrumb-item {
            color: inherit;
        }

        .breadcrumb-active {
            color: var(--builder-primary);
            font-weight: 700;
        }

        .breadcrumb-separator {
            color: var(--builder-muted);
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            margin: 0;
            font-size: clamp(1.6rem, 3vw, 2.1rem);
            font-family: var(--font-display);
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .title-icon {
            font-size: 1.7rem;
        }

        .page-subtitle {
            margin: 0;
            color: var(--builder-muted);
            font-size: 0.96rem;
            line-height: 1.5;
            max-width: 60ch;
        }

        .header-actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.7rem 1.35rem;
            border: 1px solid var(--builder-border-color);
            border-radius: var(--builder-radius-sm);
            background: var(--builder-surface-alt);
            color: var(--color-foreground);
            font-weight: 600;
            font-size: 0.88rem;
            text-decoration: none;
            cursor: pointer;
            transition: transform 120ms ease, box-shadow 120ms ease,
                border-color 120ms ease;
        }

        .action-btn:hover,
        .action-btn:focus-visible {
            transform: translateY(-1px);
            box-shadow: 0 10px 18px
                color-mix(in srgb, var(--color-foreground) 14%, transparent);
        }

        .action-btn-primary {
            background: var(--builder-primary);
            color: var(--color-primary-foreground);
            border-color: color-mix(
                in srgb,
                var(--builder-primary) 60%,
                transparent
            );
        }

        .action-btn-primary:hover,
        .action-btn-primary:focus-visible {
            background: var(--builder-primary-strong);
            border-color: var(--builder-primary-strong);
        }

        .action-btn-secondary {
            background: var(--builder-subtle);
        }

        .action-btn-danger {
            color: #b91c1c;
            border-color: color-mix(in srgb, #b91c1c 35%, transparent);
            background: color-mix(in srgb, #b91c1c 6%, transparent);
        }

        .action-btn-danger:hover,
        .action-btn-danger:focus-visible {
            background: color-mix(in srgb, #b91c1c 12%, transparent);
            border-color: color-mix(in srgb, #b91c1c 55%, transparent);
            color: #7f1d1d;
        }

        .action-btn-sm {
            padding: 0.55rem 1rem;
            font-size: 0.78rem;
        }

        .action-btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .workspace-content {
            display: grid;
            grid-template-columns: minmax(640px, 2fr) minmax(280px, 360px);
            gap: 1.25rem;
            align-items: start;
            flex: 1;
        }

        .editor-panel,
        .preview-panel {
            overflow: hidden;
            display: flex;
            flex-direction: column;
            order: 1;
            background: radial-gradient(circle at 12% 20%, color-mix(in srgb, var(--builder-primary) 16%, transparent) 0%, transparent 34%),
                radial-gradient(circle at 88% 18%, color-mix(in srgb, var(--builder-primary) 12%, transparent) 0%, transparent 32%),
                var(--builder-surface);
            border: 1px solid var(--builder-border-color);
            border-radius: var(--builder-radius-lg);
            box-shadow: var(--builder-shadow);
        }
        .side-panel {
            display: grid;
            gap: 1rem;
            position: sticky;
            top: 1rem;
            align-self: start;
            max-height: calc(100vh - 2rem);
            overflow: auto;
            padding-right: 0.25rem; /* keep inner shadow/scrollbar off content */
            order: 2;
            background: var(--builder-surface);
            border: 1px solid var(--builder-border-color);
            border-radius: var(--builder-radius-lg);
            box-shadow: var(--builder-shadow);
        }

        .panel-section {
            border-bottom: 1px solid var(--builder-border-color);
        }

        .panel-section:last-child {
            border-bottom: none;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.1rem 1.25rem;
            border-bottom: 1px solid var(--builder-border-color);
            background: var(--builder-surface-alt);
        }

        .section-header h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            font-size: 1.02rem;
            letter-spacing: 0.01em;
        }

        .settings-grid {
            display: grid;
            gap: 1.1rem;
            padding: 1.2rem 1.25rem 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
        }

        .form-group label {
            font-weight: 700;
            color: var(--color-foreground);
            font-size: 0.88rem;
            letter-spacing: 0.01em;
        }

        .input-group {
            display: flex;
            align-items: stretch;
            gap: 0;
        }

        .input-prefix {
            padding: 0.7rem 0.85rem;
            background: var(--builder-subtle);
            border: 1px solid var(--builder-border-color);
            border-right: none;
            border-radius: var(--builder-radius-sm) 0 0
                var(--builder-radius-sm);
            color: var(--builder-muted);
            font-size: 0.86rem;
            white-space: nowrap;
        }

        .form-input {
            flex: 1;
            padding: 0.7rem 0.85rem;
            border: 1px solid var(--builder-border-color);
            border-radius: 0 var(--builder-radius-sm) var(--builder-radius-sm)
                0;
            background: var(--builder-surface-alt);
            color: var(--color-foreground);
            font-size: 0.88rem;
            transition: border-color 120ms ease, box-shadow 120ms ease;
        }

        .form-input:focus {
            outline: none;
            border-color: color-mix(
                in srgb,
                var(--builder-primary) 60%,
                transparent
            );
            box-shadow: 0 0 0 3px
                color-mix(in srgb, var(--builder-primary) 22%, transparent);
        }

        .input-hint {
            font-size: 0.78rem;
            color: var(--builder-muted);
        }


        .editor-tabs {
            display: flex;
            gap: 0.3rem;
            background: var(--builder-subtle);
            padding: 0.35rem;
            border-radius: var(--builder-radius-sm);
            margin: 1rem 1.25rem 0;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .editor-tabs::-webkit-scrollbar {
            display: none;
        }

        .editor-tab {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.55rem 0.95rem;
            border: 1px solid transparent;
            background: transparent;
            color: var(--builder-muted);
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: var(--builder-radius-sm);
            transition: all 0.15s ease;
        }

        .editor-tab:hover {
            color: var(--color-foreground);
            border-color: var(--builder-border-color);
            background: var(--builder-surface);
        }

        .editor-tab.active {
            background: var(--builder-primary);
            color: var(--color-primary-foreground);
            border-color: color-mix(
                in srgb,
                var(--builder-primary) 60%,
                transparent
            );
            box-shadow: 0 6px 16px
                color-mix(in srgb, var(--builder-primary) 28%, transparent);
        }

        .editor-container {
            height: 520px;
            margin: 0 1.25rem 1.25rem;
            border: 1px solid var(--builder-border-color);
            border-radius: var(--builder-radius);
            overflow: hidden;
            background: var(--builder-code-bg);
        }

        .monaco-editor {
            height: 100%;
        }

        .hidden-editor {
            display: none;
        }

        /* Preview inline (tab mode) */
        .preview-inline {
            border: 1px solid var(--builder-border-color);
            border-radius: var(--builder-radius);
            background: var(--builder-surface-alt);
            padding: 1rem 1.15rem 1.25rem;
            display: grid;
            gap: 0.8rem;
            margin: 0 1.25rem 1.25rem;
            box-shadow: 0 12px 30px
                color-mix(in srgb, var(--color-foreground) 10%, transparent);
        }

        .preview-inline__header {
            display: flex;
            justify-content: space-between;
            gap: 0.85rem;
            flex-wrap: wrap;
            align-items: flex-start;
            border-bottom: 1px solid var(--builder-border-color);
            padding-bottom: 0.65rem;
        }

        .preview-inline__eyebrow {
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 0.68rem;
            color: var(--builder-muted);
        }

        .preview-inline__title {
            margin: 0.08rem 0 0.1rem;
            font-size: 1.05rem;
            letter-spacing: 0.01em;
        }

        .preview-inline__url {
            margin: 0;
            color: var(--builder-muted);
            font-size: 0.86rem;
        }

        .preview-inline__controls {
            display: grid;
            gap: 0.4rem;
            justify-items: end;
        }

        .preview-inline__frame {
            display: flex;
            align-items: center;
            justify-content: center;
            background: color-mix(
                in srgb,
                var(--builder-subtle) 60%,
                transparent
            );
            padding: 0.9rem;
            border-radius: var(--builder-radius-sm);
        }

        .preview-frame {
            border: 1px solid var(--builder-border-color);
            border-radius: var(--builder-radius);
            box-shadow: 0 16px 32px
                color-mix(in srgb, var(--color-foreground) 12%, transparent);
            background: var(--color-background);
            width: 100%;
            height: clamp(520px, 70vh, 900px);
            transition: transform 160ms ease, box-shadow 160ms ease;
        }

        .editor-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.9rem 1.25rem 1.1rem;
            background: var(--builder-surface-alt);
            border-top: 1px solid var(--builder-border-color);
        }

        .editor-status {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.86rem;
            color: var(--builder-muted);
        }

        .editor-status.success {
            color: var(--builder-success);
        }

        .editor-status.error {
            color: var(--builder-error);
        }

        .editor-status.warning {
            color: var(--builder-warning);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1.15rem 1.25rem 1.1rem;
            border-bottom: 1px solid var(--builder-border-color);
            background: var(--builder-surface-alt);
        }

        .preview-info h3 {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            margin: 0 0 0.4rem 0;
            font-size: 1.05rem;
        }

        .preview-meta {
            display: grid;
            gap: 0.15rem;
        }

        .preview-title {
            font-weight: 700;
        }

        .preview-url {
            font-size: 0.84rem;
            color: var(--builder-muted);
        }

        .preview-controls {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
            align-items: flex-end;
        }

        .device-selector {
            display: flex;
            gap: 0.25rem;
            background: var(--builder-subtle);
            padding: 0.25rem;
            border-radius: var(--builder-radius-sm);
        }

        .device-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.45rem 0.75rem;
            border: none;
            background: transparent;
            color: var(--builder-muted);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: var(--builder-radius-sm);
            transition: all 0.15s ease;
        }

        .device-btn--link {
            width: 40px;
            justify-content: center;
            padding: 0.45rem;
        }

        .device-btn:hover {
            background: var(--builder-surface);
            color: var(--color-foreground);
        }

        .device-btn.active {
            background: var(--builder-primary);
            color: var(--color-primary-foreground);
            box-shadow: 0 6px 14px
                color-mix(in srgb, var(--builder-primary) 28%, transparent);
        }

        .preview-actions {
            display: flex;
            gap: 0.45rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .preview-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.2rem;
            background: color-mix(
                in srgb,
                var(--builder-subtle) 60%,
                transparent
            );
        }

        .preview-frame {
            border: 1px solid var(--builder-border-color);
            border-radius: var(--builder-radius);
            box-shadow: 0 16px 32px
                color-mix(in srgb, var(--color-foreground) 12%, transparent);
            background: var(--color-background);
            width: 100%;
            height: clamp(420px, 65vh, 720px);
            transition: transform 160ms ease, box-shadow 160ms ease;
        }

        .preview-panel.fullscreen {
            position: fixed;
            inset: 0;
            z-index: 1000;
            border-radius: 0;
            background: var(--color-background);
        }

        .preview-panel.fullscreen .preview-container {
            height: 100vh;
        }

        .saved-pages-section .section-header {
            background: var(--builder-surface-alt);
        }

        .header-info h3 {
            margin: 0 0 0.2rem 0;
            font-size: 1.08rem;
        }

        .header-info p {
            margin: 0;
            color: var(--builder-muted);
            font-size: 0.85rem;
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--builder-muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
            opacity: 0.6;
        }

        .empty-state h4 {
            margin: 0 0 0.4rem 0;
            font-size: 1.1rem;
            letter-spacing: 0.01em;
        }

        .empty-state p {
            margin: 0;
            font-size: 0.85rem;
        }

        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.1rem;
            padding: 1.1rem 1.25rem 1.35rem;
        }

        .page-card {
            border: 1px solid var(--builder-border-color);
            border-radius: var(--builder-radius);
            padding: 1.2rem;
            background: var(--builder-surface-alt);
            transition: transform 140ms ease, box-shadow 140ms ease;
        }

        .page-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 26px
                color-mix(in srgb, var(--color-foreground) 12%, transparent);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.6rem;
            margin-bottom: 0.85rem;
        }

        .page-card .page-title {
            font-size: 1rem;
            margin: 0;
            letter-spacing: 0.01em;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.28rem 0.6rem;
            border-radius: 999px;
            font-size: 0.76rem;
            font-weight: 700;
            background: color-mix(
                in srgb,
                var(--builder-success) 12%,
                transparent
            );
            color: var(--builder-success);
        }

        .page-meta {
            display: grid;
            gap: 0.45rem;
            margin-bottom: 1.1rem;
        }

        .meta-item {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.86rem;
            color: var(--builder-muted);
        }

        .page-actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        @media (max-width: 1100px) {
            .workspace-content {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
            }

            .preview-controls {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 780px) {
            .builder-workspace {
                padding: 0.75rem 0.65rem 2.2rem;
                gap: 0.6rem;
            }

            .workspace-header {
                padding: 0.95rem;
            }

            .header-content {
                flex-direction: column;
                gap: 0.5rem;
            }

            .header-actions {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 0.45rem;
                justify-content: stretch;
            }

            .action-btn {
                justify-content: center;
            }

            .editor-tabs {
                margin: 0.5rem 0.5rem 0;
                padding: 0.3rem;
            }

            .editor-tab {
                font-size: 0.82rem;
                padding: 0.5rem 0.85rem;
                white-space: nowrap;
            }

            .editor-container {
                margin: 0 0.65rem 0.85rem;
                height: 260px;
            }

            .side-panel {
                position: static;
                max-height: none;
                overflow: visible;
                padding-right: 0;
            }

            .preview-inline {
                margin: 0 0.5rem 0.85rem;
                padding: 0.75rem 0.85rem 0.95rem;
            }

            .pages-grid {
                grid-template-columns: 1fr;
            }

            .preview-inline__controls {
                width: 100%;
                justify-content: space-between;
            }

            .device-selector {
                flex: 1;
                justify-content: space-between;
            }

            .device-btn {
                padding: 0.45rem 0.7rem;
                font-size: 0.78rem;
            }

            .device-btn--link {
                width: 34px;
                padding: 0.45rem;
            }

            .preview-frame {
                height: clamp(340px, 60vh, 520px);
            }

            .editor-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 0.35rem;
                padding: 0.75rem 0.75rem 0.85rem;
            }

            .editor-actions .action-btn {
                width: 100%;
            }
        }

        @media (max-width: 520px) {
            .page-actions,
            .header-actions,
            .preview-actions {
                flex-direction: column;
            }

            .preview-controls {
                align-items: stretch;
            }

            .preview-actions .action-btn,
            .header-actions .action-btn {
                width: 100%;
            }
        }
    </style>
</Layout>
