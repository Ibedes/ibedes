---
import Layout from "../../layouts/Layout.astro";
import { GLOBAL } from "../../lib/variables";
import { loadAffiliateProducts } from "../../lib/affiliates";
import { formatRupiah } from "../../lib/utils";

const affiliateProducts = await loadAffiliateProducts();
const latestAffiliateProducts = [...affiliateProducts].reverse();

// Extract unique values for suggestions
const existingIds = affiliateProducts.map((p) => p.id);
const uniqueCategories = [
    ...new Set(affiliateProducts.map((p) => p.category).filter(Boolean)),
];
const uniqueTags = [...new Set(affiliateProducts.flatMap((p) => p.tags || []))];

export const prerender = false;
---

<Layout title={`Add Affiliate Product - ${GLOBAL.username}`}>
    <div class="editor-shell">
        <header class="editor-header">
            <div class="editor-header__text">
                <p class="editor-eyebrow">Produk</p>
                <h1>Tambah produk afiliasi</h1>
                <p>
                    Antarmuka baru yang mengikuti gaya editor â€” lebih rapih,
                    fokus, dan siap membantu kamu memasukkan data produk dengan
                    cepat.
                </p>
            </div>
            <div class="editor-header__actions">
                <a href="/admin" class="editor-button editor-button--ghost">
                    <i class="fa-solid fa-arrow-left-long" aria-hidden="true"
                    ></i>
                    <span>Kembali</span>
                </a>
                <button
                    id="save-product-btn"
                    type="button"
                    class="editor-button editor-button--primary"
                >
                    <i class="fa-solid fa-save" aria-hidden="true"></i>
                    <span>Simpan produk</span>
                </button>
            </div>
        </header>

        <div class="editor-chip-row">
            <span class="editor-chip">
                <i class="fa-solid fa-box" aria-hidden="true"></i>
                {affiliateProducts.length} produk
            </span>
            <span class="editor-chip">
                <i class="fa-solid fa-layer-group" aria-hidden="true"></i>
                {uniqueCategories.length} kategori
            </span>
            <span class="editor-chip">
                <i class="fa-solid fa-hashtag" aria-hidden="true"></i>
                {uniqueTags.length} tag
            </span>
        </div>

        <div class="editor-grid editor-grid--products">
            <section class="editor-panel editor-panel--primary">
                <!-- Auto-Scrape Card -->
                <div class="editor-card editor-card--auto-scrape">
                    <div class="editor-card__head">
                        <div>
                            <p class="editor-eyebrow">Auto-fill</p>
                            <h3>ðŸš€ Ambil data otomatis</h3>
                        </div>
                        <span class="editor-pill editor-pill--success"
                            >Baru</span
                        >
                    </div>
                    <div class="editor-field">
                        <label for="auto-scrape-url" class="editor-label">
                            Link produk marketplace
                        </label>
                        <div class="editor-input-group">
                            <input
                                type="url"
                                id="auto-scrape-url"
                                placeholder="https://shopee.co.id/... atau https://tokopedia.com/..."
                                class="editor-input"
                            />
                            <button
                                type="button"
                                id="fetch-product-btn"
                                class="editor-button editor-button--primary"
                                title="Ambil data produk"
                            >
                                <i
                                    class="fa-solid fa-download"
                                    aria-hidden="true"></i>
                                <span>Ambil Data</span>
                            </button>
                        </div>
                        <p class="editor-hint">
                            <strong>âœ… Support:</strong> Shopee, Tokopedia, & TikTok
                            Shop.
                            <br />
                            <strong>ðŸ’¡ Tips:</strong>
                            <br />â€¢ Pastikan link valid (bisa dibuka di browser)
                            <br />â€¢ Jika harga tidak sesuai, silakan koreksi
                            manual
                            <br />â€¢ Data diambil dari Open Graph & Metadata
                            marketplace
                        </p>
                    </div>
                    <div id="scrape-status" class="editor-status hidden">
                        <i class="fa-solid fa-circle-info"></i>
                        <span></span>
                    </div>
                </div>

                <div class="editor-panel__head">
                    <div>
                        <p class="editor-eyebrow">Form produk</p>
                        <h2>Detail utama</h2>
                    </div>
                    <span class="editor-hint">
                        Pastikan ID unik dan isi minimal nama, harga, serta
                        tautan afiliasi.
                    </span>
                </div>

                <div class="editor-form-stack">
                    <div class="editor-card">
                        <div class="editor-card__head">
                            <div>
                                <p class="editor-eyebrow">Identitas</p>
                                <h3>ID & nama produk</h3>
                            </div>
                        </div>
                        <div class="editor-field-grid editor-field-grid--two">
                            <div class="editor-field">
                                <label for="product-id" class="editor-label"
                                    >Product ID*</label
                                >
                                <input
                                    type="text"
                                    id="product-id"
                                    placeholder="jas-hujan-sp4"
                                    required
                                    class="editor-input"
                                    list="existing-ids"
                                />
                                <datalist id="existing-ids">
                                    {
                                        existingIds.map((id) => (
                                            <option value={id} />
                                        ))
                                    }
                                </datalist>
                                <p class="editor-hint">
                                    Gunakan huruf kecil dan tanda hubung.
                                </p>
                            </div>
                            <div class="editor-field">
                                <label for="product-name" class="editor-label"
                                    >Nama Produk*</label
                                >
                                <input
                                    type="text"
                                    id="product-name"
                                    placeholder="Jas Hujan Premium"
                                    required
                                    class="editor-input"
                                />
                            </div>
                        </div>
                        <div class="editor-field">
                            <label
                                for="product-description"
                                class="editor-label">Deskripsi*</label
                            >
                            <textarea
                                id="product-description"
                                rows="3"
                                placeholder="Deskripsi singkat"
                                required
                                class="editor-textarea editor-textarea--small"
                            ></textarea>
                        </div>
                    </div>

                    <div class="editor-card">
                        <div class="editor-card__head">
                            <div>
                                <p class="editor-eyebrow">Harga</p>
                                <h3>Detail penawaran</h3>
                            </div>
                        </div>
                        <div class="editor-field-grid editor-field-grid--two">
                            <div class="editor-field">
                                <label for="product-price" class="editor-label"
                                    >Harga</label
                                >
                                <input
                                    type="text"
                                    id="product-price"
                                    placeholder="Rp 80.000"
                                    inputmode="numeric"
                                    data-currency-input
                                    class="editor-input"
                                />
                            </div>
                            <div class="editor-field">
                                <label
                                    for="product-original-price"
                                    class="editor-label"
                                >
                                    Harga awal
                                </label>
                                <input
                                    type="text"
                                    id="product-original-price"
                                    placeholder="Rp 100.000"
                                    inputmode="numeric"
                                    data-currency-input
                                    class="editor-input"
                                />
                            </div>
                        </div>
                        <div class="editor-field-grid editor-field-grid--two">
                            <div class="editor-field">
                                <label
                                    for="product-discount"
                                    class="editor-label">Diskon</label
                                >
                                <input
                                    type="text"
                                    id="product-discount"
                                    placeholder="20%"
                                    class="editor-input"
                                />
                            </div>
                            <div class="editor-field">
                                <label for="product-rating" class="editor-label"
                                    >Rating</label
                                >
                                <input
                                    type="number"
                                    id="product-rating"
                                    placeholder="4.8"
                                    min="0"
                                    max="5"
                                    step="0.1"
                                    class="editor-input"
                                />
                            </div>
                        </div>
                        <label class="editor-toggle">
                            <input type="checkbox" id="product-verified" />
                            <span>Tandai sebagai produk terverifikasi</span>
                        </label>
                    </div>

                    <div class="editor-card">
                        <div class="editor-card__head">
                            <div>
                                <p class="editor-eyebrow">Distribusi</p>
                                <h3>Platform & media</h3>
                            </div>
                        </div>
                        <div class="editor-field">
                            <label for="product-platform" class="editor-label"
                                >Platform*</label
                            >
                            <select
                                id="product-platform"
                                required
                                class="editor-input"
                            >
                                <option value="shopee">Shopee</option>
                                <option value="tokopedia">Tokopedia</option>
                                <option value="lazada">Lazada</option>
                                <option value="blibli">Blibli</option>
                                <option value="tiktok">TikTok Shop</option>
                                <option value="amazon">Amazon</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="editor-field">
                            <label for="product-image" class="editor-label"
                                >Image URL*</label
                            >
                            <input
                                type="url"
                                id="product-image"
                                placeholder="https://example.com/image.jpg"
                                required
                                class="editor-input"
                            />
                        </div>
                        <div class="editor-field">
                            <label for="product-link" class="editor-label"
                                >Affiliate Link*</label
                            >
                            <input
                                type="url"
                                id="product-link"
                                placeholder="https://affiliate-link.com"
                                required
                                class="editor-input"
                            />
                        </div>
                    </div>

                    <div class="editor-card">
                        <div class="editor-card__head">
                            <div>
                                <p class="editor-eyebrow">Klasifikasi</p>
                                <h3>Kategori & tag</h3>
                            </div>
                        </div>
                        <div class="editor-field-grid editor-field-grid--two">
                            <div class="editor-field">
                                <label
                                    for="product-category"
                                    class="editor-label">Kategori</label
                                >
                                <input
                                    type="text"
                                    id="product-category"
                                    placeholder="Productivity"
                                    class="editor-input"
                                    list="categories-list"
                                />
                                <datalist id="categories-list">
                                    {
                                        uniqueCategories.map((cat) => (
                                            <option value={cat} />
                                        ))
                                    }
                                </datalist>
                            </div>
                            <div class="editor-field">
                                <label for="product-tags" class="editor-label"
                                    >Tags</label
                                >
                                <input
                                    type="text"
                                    id="product-tags"
                                    placeholder="outdoor, waterproof"
                                    class="editor-input"
                                    list="tags-list"
                                />
                                <datalist id="tags-list">
                                    {
                                        uniqueTags.map((tag) => (
                                            <option value={tag} />
                                        ))
                                    }
                                </datalist>
                                <p class="editor-hint">Pisahkan dengan koma.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <aside class="editor-stack">
                <div class="editor-card">
                    <div class="editor-card__head">
                        <div>
                            <p class="editor-eyebrow">Inventori</p>
                            <h3>Produk tersimpan</h3>
                        </div>
                        <span class="editor-pill"
                            >{affiliateProducts.length} item</span
                        >
                    </div>
                    {
                        affiliateProducts.length > 0 && (
                            <div class="editor-field">
                                <label
                                    for="inventory-search"
                                    class="editor-label"
                                >
                                    Cari produk
                                </label>
                                <input
                                    type="search"
                                    id="inventory-search"
                                    class="editor-input"
                                    placeholder="Cari nama, ID, kategori, atau tag"
                                    autocomplete="off"
                                />
                                <p class="editor-hint">
                                    Menampilkan produk terbaru di urutan
                                    teratas.
                                </p>
                            </div>
                        )
                    }
                    <div class="editor-product-list" data-product-list>
                        {
                            affiliateProducts.length > 0
                                ? latestAffiliateProducts.map((product) => (
                                      <article
                                          class="editor-product"
                                          data-product-card
                                          data-product-keywords={[
                                              product.name,
                                              product.id,
                                              product.category ?? "",
                                              ...(product.tags ?? []),
                                          ]
                                              .join(" ")
                                              .toLowerCase()}
                                      >
                                          <div class="editor-product__media">
                                              <img
                                                  src={product.image}
                                                  alt={product.name}
                                                  loading="lazy"
                                              />
                                          </div>
                                          <div class="editor-product__body">
                                              <p class="editor-product__title">
                                                  {product.name}
                                              </p>
                                              <p class="editor-product__meta">
                                                  {product.category ||
                                                      "Uncategorized"}
                                              </p>
                                              <p class="editor-product__price">
                                                  {formatRupiah(product.price)}
                                                  {product.discount && (
                                                      <span class="editor-product__discount">
                                                          {product.discount}
                                                      </span>
                                                  )}
                                              </p>
                                              <p class="editor-product__id">
                                                  {product.id}
                                              </p>
                                          </div>
                                          <div class="editor-product__actions">
                                              <a
                                                  href={`/admin/edit-product?id=${product.id}`}
                                                  class="editor-product__button editor-product__button--ghost"
                                              >
                                                  <i
                                                      class="fa-solid fa-pen-to-square"
                                                      aria-hidden="true"
                                                  />
                                                  Edit
                                              </a>
                                              <button
                                                  type="button"
                                                  class="editor-product__button editor-product__button--danger"
                                                  data-product-delete={
                                                      product.id
                                                  }
                                                  data-product-name={
                                                      product.name
                                                  }
                                              >
                                                  <i
                                                      class="fa-solid fa-trash"
                                                      aria-hidden="true"
                                                  />
                                                  Hapus
                                              </button>
                                          </div>
                                      </article>
                                  ))
                                : null
                        }
                    </div>
                    <p class="editor-empty hidden" data-product-search-empty>
                        Tidak ada produk yang cocok dengan pencarianmu.
                    </p>
                    <p
                        class={`editor-empty ${affiliateProducts.length ? "hidden" : ""}`}
                        data-product-empty
                    >
                        Belum ada produk afiliasi tersimpan.
                    </p>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const saveBtn = document.getElementById(
            "save-product-btn",
        ) as HTMLButtonElement;
        const priceInput = document.getElementById(
            "product-price",
        ) as HTMLInputElement;
        const originalPriceInput = document.getElementById(
            "product-original-price",
        ) as HTMLInputElement;
        const discountInput = document.getElementById(
            "product-discount",
        ) as HTMLInputElement;
        const ratingInput = document.getElementById(
            "product-rating",
        ) as HTMLInputElement;

        // Auto-scrape elements
        const fetchBtn = document.getElementById("fetch-product-btn");
        const scrapeUrlInput = document.getElementById(
            "auto-scrape-url",
        ) as HTMLInputElement;
        const scrapeStatus = document.getElementById("scrape-status");
        const productNameInput = document.getElementById(
            "product-name",
        ) as HTMLInputElement;
        const productDescInput = document.getElementById(
            "product-description",
        ) as HTMLTextAreaElement;
        const productImageInput = document.getElementById(
            "product-image",
        ) as HTMLInputElement;
        const productLinkInput = document.getElementById(
            "product-link",
        ) as HTMLInputElement;
        const productPlatformSelect = document.getElementById(
            "product-platform",
        ) as HTMLSelectElement;

        const getNumericValue = (value = "") =>
            value.toString().replace(/[^0-9]/g, "");

        const formatCurrencyDisplay = (digits = "") =>
            digits ? `Rp ${digits.replace(/\B(?=(\d{3})+(?!\d))/g, ".")}` : "";

        // Auto-scrape functionality
        function showScrapeStatus(
            message: string,
            type: "info" | "success" | "error",
        ) {
            if (!scrapeStatus) return;

            scrapeStatus.classList.remove(
                "hidden",
                "editor-status--info",
                "editor-status--success",
                "editor-status--error",
            );
            scrapeStatus.classList.add(`editor-status--${type}`);

            const icon = scrapeStatus.querySelector("i");
            const span = scrapeStatus.querySelector("span");

            if (icon) {
                icon.className =
                    type === "success"
                        ? "fa-solid fa-circle-check"
                        : type === "error"
                          ? "fa-solid fa-circle-exclamation"
                          : "fa-solid fa-circle-info";
            }

            if (span) {
                span.textContent = message;
            }
        }

        function hideScrapeStatus() {
            if (scrapeStatus) {
                scrapeStatus.classList.add("hidden");
            }
        }

        function generateProductId(name: string): string {
            return name
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, "")
                .replace(/\s+/g, "-")
                .substring(0, 50);
        }

        fetchBtn?.addEventListener("click", async () => {
            const url = scrapeUrlInput?.value.trim();

            if (!url) {
                showScrapeStatus(
                    "Masukkan URL produk terlebih dahulu",
                    "error",
                );
                return;
            }

            try {
                (fetchBtn as HTMLButtonElement).disabled = true;
                fetchBtn.innerHTML =
                    '<i class="fa-solid fa-spinner fa-spin"></i> Mengambil data...';
                showScrapeStatus(
                    "Sedang mengambil data dari marketplace...",
                    "info",
                );

                const response = await fetch("/api/fetch-product-data", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ url }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    const data = result.data;

                    // Check if data is empty (scraping failed)
                    const hasData = data.title || data.image || data.price;

                    if (!hasData) {
                        showScrapeStatus(
                            "âš ï¸ Auto-scrape gagal. Silakan isi form manual. Link sudah terisi di bawah.",
                            "error",
                        );
                        // Still fill the link
                        if (productLinkInput) {
                            productLinkInput.value = url;
                        }
                        return;
                    }

                    // Auto-fill form fields
                    if (data.title && productNameInput) {
                        productNameInput.value = data.title;
                        // Auto-generate ID from title
                        const productIdInput = document.getElementById(
                            "product-id",
                        ) as HTMLInputElement;
                        if (productIdInput && !productIdInput.value) {
                            productIdInput.value = generateProductId(
                                data.title,
                            );
                        }
                    } else {
                        // This else block was part of the debugging. Removing the console.log inside it.
                    }

                    if (data.description && productDescInput) {
                        productDescInput.value = data.description;
                    }

                    if (data.image && productImageInput) {
                        productImageInput.value = data.image;
                    }

                    if (data.price && priceInput) {
                        priceInput.value = data.price;
                        // Trigger currency formatting
                        const event = new Event("blur");
                        priceInput.dispatchEvent(event);
                    }

                    if (productLinkInput) {
                        productLinkInput.value = url;
                    }

                    if (data.platform && productPlatformSelect) {
                        productPlatformSelect.value = data.platform;
                    }

                    showScrapeStatus(
                        "âœ… Data berhasil diambil! Silakan cek dan lengkapi form di bawah.",
                        "success",
                    );

                    // Clear URL input after successful fetch
                    setTimeout(() => {
                        if (scrapeUrlInput) scrapeUrlInput.value = "";
                        hideScrapeStatus();
                    }, 5000);
                } else {
                    showScrapeStatus(
                        result.error || "Gagal mengambil data produk",
                        "error",
                    );
                }
            } catch (error) {
                console.error("Fetch error:", error);
                showScrapeStatus(
                    "Terjadi kesalahan saat mengambil data. Coba lagi.",
                    "error",
                );
            } finally {
                (fetchBtn as HTMLButtonElement).disabled = false;
                fetchBtn.innerHTML =
                    '<i class="fa-solid fa-download"></i> <span>Ambil Data</span>';
            }
        });

        // Allow Enter key to trigger fetch
        scrapeUrlInput?.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                fetchBtn?.click();
            }
        });

        function enhanceCurrencyInput(input: HTMLInputElement) {
            if (!input) return;
            const applyFormat = () => {
                const digits = getNumericValue(input.value);
                input.value = formatCurrencyDisplay(digits);
            };
            input.addEventListener("focus", () => {
                input.value = getNumericValue(input.value);
            });
            input.addEventListener("blur", applyFormat);
            applyFormat();
        }

        document
            .querySelectorAll("[data-currency-input]")
            .forEach((input) =>
                enhanceCurrencyInput(input as HTMLInputElement),
            );

        // Auto-calculate discount
        function calculateDiscount() {
            if (!priceInput || !originalPriceInput || !discountInput) return;

            const priceStr = getNumericValue(priceInput.value);
            const originalPriceStr = getNumericValue(originalPriceInput.value);

            if (priceStr && originalPriceStr) {
                const price = parseInt(priceStr);
                const originalPrice = parseInt(originalPriceStr);

                if (originalPrice > price) {
                    const discount = Math.round(
                        ((originalPrice - price) / originalPrice) * 100,
                    );
                    discountInput.value = `${discount}%`;
                }
            }
        }

        priceInput?.addEventListener("input", calculateDiscount);
        originalPriceInput?.addEventListener("input", calculateDiscount);

        saveBtn?.addEventListener("click", async () => {
            const productIdInput = document.getElementById(
                "product-id",
            ) as HTMLInputElement;
            const productNameInput = document.getElementById(
                "product-name",
            ) as HTMLInputElement;
            const descriptionInput = document.getElementById(
                "product-description",
            ) as HTMLTextAreaElement;
            const priceInput = document.getElementById(
                "product-price",
            ) as HTMLInputElement;
            const originalPriceInput = document.getElementById(
                "product-original-price",
            ) as HTMLInputElement;
            const discountInput = document.getElementById(
                "product-discount",
            ) as HTMLInputElement;
            const platformInput = document.getElementById(
                "product-platform",
            ) as HTMLSelectElement;
            const imageInput = document.getElementById(
                "product-image",
            ) as HTMLInputElement;
            const linkInput = document.getElementById(
                "product-link",
            ) as HTMLInputElement;
            const categoryInput = document.getElementById(
                "product-category",
            ) as HTMLInputElement;
            const tagsInput = document.getElementById(
                "product-tags",
            ) as HTMLInputElement;
            const verifiedInput = document.getElementById(
                "product-verified",
            ) as HTMLInputElement;

            const productId = productIdInput?.value.trim();
            const productName = productNameInput?.value.trim();
            const description = descriptionInput?.value.trim();
            const priceValue = getNumericValue(priceInput?.value);
            const originalPriceValue = getNumericValue(
                originalPriceInput?.value,
            );
            const discount = discountInput?.value.trim();
            const platform = platformInput?.value;
            const image = imageInput?.value.trim();
            const link = linkInput?.value.trim();
            let categoryRaw = categoryInput?.value.trim();
            const category = categoryRaw
                ? categoryRaw.split(",")[0].trim()
                : "General";
            const tagsRaw = tagsInput?.value;
            const tags = tagsRaw
                ? [
                      ...new Set(
                          tagsRaw
                              .split(",")
                              .map((t) => t.trim())
                              .filter((t) => t),
                      ),
                  ]
                : [];
            const verified = verifiedInput?.checked;
            const rating = ratingInput?.value.trim();

            if (!productId || !productName || !description || !image || !link) {
                alert("Please fill all required fields");
                return;
            }

            const product = {
                id: productId,
                name: productName,
                description,
                price: priceValue || undefined,
                originalPrice: originalPriceValue || undefined,
                discount: discount || undefined,
                image,
                link,
                platform,
                category: category || "General",
                tags,
                rating: rating ? parseFloat(rating) : undefined,
                verified,
            };

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML =
                    '<i class="fa-solid fa-spinner fa-spin"></i> Menyimpan...';

                const response = await fetch("/api/admin/add-product", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(product),
                });

                const result = await response.json();

                if (response.ok) {
                    alert("Product added successfully!");

                    setTimeout(() => {
                        window.location.href = "/admin?t=" + Date.now();
                    }, 1500);
                } else {
                    alert("Error: " + result.error);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML =
                        '<i class="fa-solid fa-save"></i> Simpan produk';
                }
            } catch (error) {
                console.error(error);
                alert("Failed to save product");
                saveBtn.disabled = false;
                saveBtn.innerHTML =
                    '<i class="fa-solid fa-save"></i> Simpan produk';
            }
        });

        const productList = document.querySelector("[data-product-list]");
        const emptyState = document.querySelector("[data-product-empty]");
        const productSearchInput = document.getElementById(
            "inventory-search",
        ) as HTMLInputElement;
        const productSearchEmpty = document.querySelector(
            "[data-product-search-empty]",
        );

        const getProductCards = () =>
            productList
                ? (Array.from(
                      productList.querySelectorAll("[data-product-card]"),
                  ) as HTMLElement[])
                : [];

        function refreshEmptyState() {
            if (!productList || !emptyState) return;
            const hasItems = getProductCards().length;
            if (hasItems) {
                emptyState.classList.add("hidden");
            } else {
                emptyState.classList.remove("hidden");
            }
        }

        function applyProductSearchFilter() {
            if (!productSearchInput) return;
            const term = productSearchInput.value.trim().toLowerCase();
            const cards = getProductCards();
            let visibleCount = 0;
            cards.forEach((card) => {
                const keywords = card.dataset.productKeywords || "";
                const isVisible = !term || keywords.includes(term);
                card.classList.toggle("hidden", !isVisible);
                if (isVisible) {
                    visibleCount += 1;
                }
            });
            if (productSearchEmpty) {
                const hasQuery = term.length > 0;
                productSearchEmpty.classList.toggle(
                    "hidden",
                    !hasQuery || visibleCount > 0,
                );
            }
        }

        productSearchInput?.addEventListener("input", applyProductSearchFilter);
        applyProductSearchFilter();

        productList?.addEventListener("click", async (event) => {
            const target = event.target as HTMLElement;
            const button = target.closest(
                "[data-product-delete]",
            ) as HTMLButtonElement | null;
            if (!button) return;

            const productId = button.dataset.productDelete;
            const productName = button.dataset.productName || productId;
            if (
                !productId ||
                !confirm(
                    `Hapus produk "${productName}"? Tindakan ini tidak bisa dibatalkan.`,
                )
            ) {
                return;
            }

            const card = button.closest("[data-product-card]");
            const originalContent = button.innerHTML;
            try {
                button.disabled = true;
                button.innerHTML =
                    '<i class="fa-solid fa-spinner fa-spin"></i>';

                const response = await fetch("/api/admin/delete-product", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ id: productId }),
                });

                const result = await response.json();

                if (response.ok) {
                    alert("Produk dihapus");
                    card?.classList.add("is-removing");
                    setTimeout(() => {
                        card?.remove();
                        refreshEmptyState();
                        applyProductSearchFilter();
                    }, 250);
                } else {
                    alert(result.error || "Failed to delete product");
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            } catch (error) {
                console.error(error);
                alert("Error deleting product");
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        });
    </script>

    <style>
        .editor-shell {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1.5rem 1.25rem 4rem;
            --editor-border: 1px solid
                color-mix(in srgb, var(--color-foreground) 14%, transparent);
            --editor-card-bg: color-mix(
                in srgb,
                var(--color-card) 92%,
                transparent
            );
            --editor-radius: 1rem;
        }

        .editor-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1.25rem;
            border: var(--editor-border);
            border-radius: var(--editor-radius);
            background: var(--editor-card-bg);
        }

        @media (min-width: 768px) {
            .editor-header {
                flex-direction: row;
                align-items: flex-start;
                justify-content: space-between;
            }
        }

        .editor-header__text h1 {
            font-family: var(--font-display);
            font-size: clamp(1.4rem, 3vw, 1.9rem);
            margin: 0;
        }

        .editor-header__text p {
            margin: 0.35rem 0 0;
            max-width: 48ch;
            color: color-mix(in srgb, var(--color-foreground) 70%, transparent);
        }

        .editor-header__actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .editor-eyebrow {
            font-size: 0.7rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: color-mix(in srgb, var(--color-foreground) 55%, transparent);
            margin: 0 0 0.2rem 0;
        }

        .editor-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            border-radius: 0.85rem;
            padding: 0.6rem 1.1rem;
            border: var(--editor-border);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            cursor: pointer;
            background: transparent;
            color: inherit;
            transition:
                transform 150ms ease,
                border-color 150ms ease,
                background-color 150ms ease;
        }

        .editor-button--ghost {
            background: transparent;
        }

        .editor-button--soft {
            background: color-mix(
                in srgb,
                var(--color-foreground) 4%,
                transparent
            );
        }

        .editor-button--primary {
            background: var(--color-primary);
            border-color: color-mix(
                in srgb,
                var(--color-primary) 60%,
                transparent
            );
            color: var(--color-background);
        }

        .editor-button:hover,
        .editor-button:focus-visible {
            transform: translateY(-1px);
        }

        .editor-chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0 1.25rem;
        }

        .editor-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: var(--editor-border);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .editor-grid {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
            gap: 1.25rem;
        }

        @media (max-width: 1024px) {
            .editor-grid {
                grid-template-columns: 1fr;
            }
        }

        .editor-panel {
            border: var(--editor-border);
            border-radius: var(--editor-radius);
            background: var(--editor-card-bg);
            padding: 1rem;
        }

        .editor-panel__head {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .editor-hint {
            font-size: 0.8rem;
            color: color-mix(in srgb, var(--color-foreground) 60%, transparent);
        }

        .editor-stack {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .editor-card {
            border: var(--editor-border);
            border-radius: var(--editor-radius);
            background: var(--editor-card-bg);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
        }

        .editor-card__head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-card--auto-scrape {
            background: linear-gradient(
                135deg,
                color-mix(in srgb, var(--color-primary) 8%, transparent),
                color-mix(in srgb, var(--color-card) 95%, transparent)
            );
            border-color: color-mix(
                in srgb,
                var(--color-primary) 20%,
                transparent
            );
        }

        .editor-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: stretch;
        }

        .editor-input-group .editor-input {
            flex: 1;
        }

        .editor-input-group .editor-button {
            flex-shrink: 0;
            white-space: nowrap;
        }

        .editor-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .editor-status--info {
            background: color-mix(in srgb, #3b82f6 15%, transparent);
            border: 1px solid color-mix(in srgb, #3b82f6 30%, transparent);
            color: #3b82f6;
        }

        .editor-status--success {
            background: color-mix(in srgb, #10b981 15%, transparent);
            border: 1px solid color-mix(in srgb, #10b981 30%, transparent);
            color: #10b981;
        }

        .editor-status--error {
            background: color-mix(in srgb, #ef4444 15%, transparent);
            border: 1px solid color-mix(in srgb, #ef4444 30%, transparent);
            color: #ef4444;
        }

        .editor-pill--success {
            background: color-mix(in srgb, #10b981 20%, transparent);
            color: #10b981;
            border-color: color-mix(in srgb, #10b981 30%, transparent);
        }

        .editor-card__head h3 {
            margin: 0;
            font-size: 1rem;
        }

        .editor-pill {
            font-size: 0.75rem;
            padding: 0.15rem 0.6rem;
            border-radius: 999px;
            border: var(--editor-border);
        }

        .editor-field {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .editor-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: color-mix(in srgb, var(--color-foreground) 60%, transparent);
        }

        .editor-input,
        .editor-input-group input,
        .editor-field select {
            border: var(--editor-border);
            border-radius: 0.8rem;
            background: transparent;
            padding: 0.65rem 0.9rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            width: 100%;
        }

        .editor-textarea {
            width: 100%;
            min-height: 100px;
            border-radius: 0.9rem;
            border: var(--editor-border);
            background: transparent;
            padding: 0.85rem 1rem;
            font-family: var(--font-mono);
            font-size: 0.95rem;
            resize: vertical;
            line-height: 1.55;
        }

        .editor-textarea--small {
            min-height: 120px;
        }

        .editor-form-stack {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .editor-field-grid {
            display: grid;
            gap: 0.85rem;
        }

        @media (min-width: 640px) {
            .editor-field-grid--two {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .editor-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            margin-top: 0.2rem;
        }

        .editor-toggle input {
            accent-color: var(--color-primary);
            width: 1rem;
            height: 1rem;
        }

        .editor-product-list {
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
        }

        .editor-product {
            border: var(--editor-border);
            border-radius: 0.9rem;
            padding: 0.85rem;
            display: grid;
            grid-template-columns: auto minmax(0, 1fr);
            gap: 0.85rem;
            align-items: center;
            background: color-mix(
                in srgb,
                var(--color-background) 95%,
                transparent
            );
        }

        .editor-product.is-removing {
            opacity: 0.4;
            transform: scale(0.98);
            transition:
                opacity 150ms ease,
                transform 150ms ease;
        }

        .editor-product__media {
            width: 64px;
            height: 64px;
            border-radius: 0.75rem;
            border: var(--editor-border);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .editor-product__media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .editor-product__body {
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 0.2rem;
        }

        .editor-product__title {
            margin: 0;
            font-weight: 600;
        }

        .editor-product__meta,
        .editor-product__id {
            margin: 0;
            font-size: 0.8rem;
            color: color-mix(in srgb, var(--color-foreground) 65%, transparent);
        }

        .editor-product__price {
            margin: 0.15rem 0;
            font-family: var(--font-mono);
        }

        .editor-product__discount {
            margin-left: 0.35rem;
            font-size: 0.75rem;
            color: color-mix(in srgb, crimson 70%, transparent);
        }

        .editor-product__actions {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            align-self: stretch;
        }

        .editor-product__button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            border-radius: 0.85rem;
            padding: 0.4rem 0.8rem;
            border: var(--editor-border);
            font-family: var(--font-mono);
            font-size: 0.85rem;
            cursor: pointer;
            background: transparent;
            color: inherit;
        }

        .editor-product__button--ghost {
            background: color-mix(
                in srgb,
                var(--color-foreground) 4%,
                transparent
            );
        }

        .editor-product__button--danger {
            border-color: color-mix(in srgb, crimson 40%, transparent);
            color: color-mix(in srgb, crimson 70%, transparent);
        }

        .editor-empty {
            text-align: center;
            margin-top: 1rem;
            color: color-mix(in srgb, var(--color-foreground) 60%, transparent);
        }

        .hidden {
            display: none !important;
        }
    </style>
</Layout>
