---
import Section from "../components/common/Section.astro";
import Breadcrumb from "../components/common/Breadcrumb.astro";
import type { ArticleFrontmatter } from "../lib/types";
import {
  getShortDescription,
  processArticleDate,
  generateSourceUrl,
} from "../lib/utils";
import { GLOBAL } from "../lib/variables";
import type { MarkdownLayoutProps } from "astro";
import Prose from "../components/Prose.astro";
import Layout from "./Layout.astro";
import SubscribeCard from "../components/SubscribeCard.astro";
import ShareActions from "../components/ShareActions.astro";
import FloatingReactions from "../components/FloatingReactions.astro";
import AffiliateProducts from "../components/AffiliateProducts.astro";
import ReadingProgress from "../components/ReadingProgress.astro";
import TextShareTooltip from "../components/TextShareTooltip.astro";
import {
  getAffiliateByArticle,
  getAffiliateProductsByIds,
} from "../lib/affiliates";
import { generateArticleSchema } from "../lib/seo";
import TableOfContents from "../components/TableOfContents.astro";
import RelatedArticles from "../components/RelatedArticles.astro";
import CodeCopy from "../components/CodeCopy.astro";
import ImageLightbox from "../components/ImageLightbox.astro";
import BackToTop from "../components/BackToTop.astro";
import AuthorBio from "../components/AuthorBio.astro";

type Props = {
  frontmatter: ArticleFrontmatter;
  headings: import("astro").MarkdownHeading[];
  file?: string;
  url?: string;
  rawContent?: () => string;
  compiledContent?: () => string;
};

const { frontmatter, headings } = Astro.props;
const shortDescription = getShortDescription(frontmatter.description);
const articleDate = processArticleDate(frontmatter.timestamp);
const sourceUrl = frontmatter.filename
  ? generateSourceUrl(frontmatter.filename, "blog")
  : "";
const canonicalUrl = `${GLOBAL.rootUrl}${sourceUrl}`;

// Breadcrumb items
const breadcrumbItems = [
  { name: "Home", url: "/" },
  { name: "Blog", url: "/blog" },
  { name: frontmatter.title, url: sourceUrl },
];

// Generate Article structured data
const featuredImageUrl = frontmatter.featuredImage
  ? new URL(frontmatter.featuredImage, GLOBAL.rootUrl).href
  : undefined;

const articleSchema = generateArticleSchema(
  {
    title: frontmatter.title,
    description: frontmatter.description,
    publishedTime: frontmatter.timestamp,
    author: GLOBAL.username,
    tags: frontmatter.tags,
    url: canonicalUrl,
    image: featuredImageUrl,
  },
  GLOBAL.rootUrl,
);

// Generate social meta tags with dynamic OG image
const ogImageUrl = frontmatter.filename
  ? `${GLOBAL.rootUrl}/og/${frontmatter.filename}.svg`
  : `${GLOBAL.rootUrl}/og/default.svg`;
const seoImage = featuredImageUrl ?? ogImageUrl;

// Load affiliate products server-side so HTML langsung muncul
const affiliateProductIds = frontmatter.affiliateProducts || [];
let affiliateProducts: any[] = [];

if (affiliateProductIds.length > 0) {
  try {
    affiliateProducts = await getAffiliateProductsByIds(affiliateProductIds);
    console.log("[BlogLayout] Loaded affiliate products server-side:", affiliateProducts.length);
  } catch (error) {
    console.error("[BlogLayout] Failed to load affiliate products server-side:", error);
    affiliateProducts = [];
  }
}

// Debug logging for affiliate products
console.log("[BlogLayout] Article will load affiliate products client-side:", {
  filename: frontmatter.filename,
  productIds: affiliateProductIds
});


---

<Layout
  title={`${frontmatter.title} â€¢ ${GLOBAL.username}`}
  description={frontmatter.description}
  image={seoImage}
  imageAlt={frontmatter.featuredImageAlt || frontmatter.title}
  type="article"
  canonicalURL={canonicalUrl}
  breadcrumbs={breadcrumbItems}
  keywords={frontmatter.tags?.join(", ")}
>
  <Section class="pt-8 !max-w-6xl">
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_250px] gap-12 relative">
      <div class="w-full min-w-0">
        <div class="max-w-prose mx-auto lg:ml-auto lg:mr-0">
          <!-- Breadcrumb Navigation -->
          <Breadcrumb items={breadcrumbItems} />

          <div class="flex flex-col gap-4 mt-8 mb-8 w-full">
            <h1
              class="text-3xl sm:text-4xl leading-tight font-display break-words"
            >
              {frontmatter.title}
            </h1>

            <div
              class="flex justify-between items-center text-sm w-full text-muted-foreground font-mono"
            >
              <span class="whitespace-nowrap">
                {
                  processArticleDate(
                    frontmatter.pubDate || frontmatter.timestamp || new Date().toISOString(),
                  )
                }
              </span>
              <span class="whitespace-nowrap">
                {frontmatter.minutesRead || frontmatter.time || "5 min"} read
              </span>
            </div>
          </div>

          {
            frontmatter.featuredImage && (
              <figure class="mb-10 w-full">
                <div class="rounded-xl overflow-hidden shadow-sm">
                  <img
                    src={frontmatter.featuredImage}
                    alt={frontmatter.featuredImageAlt || frontmatter.title}
                    class="w-full h-auto object-cover max-h-[500px]"
                  />
                </div>
                {frontmatter.featuredImageCaption && (
                  <figcaption class="mt-3 text-center text-sm text-muted-foreground italic font-mono">
                    <Fragment set:html={frontmatter.featuredImageCaption} />
                  </figcaption>
                )}
              </figure>
            )
          }

          <Prose id="article-content">
            <slot />
          </Prose>

          <!-- TOC stopper so sidebar only sticks along article body -->
          <div id="toc-end-sentinel" class="h-px" aria-hidden="true"></div>

          <AuthorBio />

          <!-- Affiliate Products Section -->
          {
            affiliateProducts.length > 0 && (
              <div class="my-12">
                <AffiliateProducts
                  products={affiliateProducts}
                  context={frontmatter.affiliateContext}
                  title="Produk yang Mungkin Bantu"
                />
              </div>
            )
          }

          <div class="my-12">
            <ShareActions
              title={frontmatter.title}
              url={sourceUrl}
              image={ogImageUrl}
            />
          </div>

          <div class="my-12">
            <SubscribeCard />
          </div>

          <RelatedArticles
            currentSlug={frontmatter.filename
              ? (frontmatter.filename.split("/").pop() ?? "")
              : ""}
            tags={frontmatter.tags ?? []}
          />
        </div>
      </div>

      <aside class="hidden lg:block relative lg:self-start lg:max-h-[calc(100vh-6rem)] lg:overflow-y-auto">
        <TableOfContents headings={headings} />
      </aside>
    </div>
  </Section>

  <ReadingProgress />
  <TextShareTooltip
    title={frontmatter.title}
    url={sourceUrl}
  />
  <FloatingReactions
    slug={frontmatter.filename || "default"}
    title={frontmatter.title}
  />

  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <!-- Article-specific Analytics -->
  <script
    is:inline
    define:vars={{
      articleTitle: frontmatter.title,
      articleTags: frontmatter.tags?.join(",") || "",
      readingTime: frontmatter.time,
    }}
  >
    // Track article view
    if (typeof window !== "undefined") {
      window.addEventListener("load", () => {
        if (typeof window.trackPageView === "function") {
          window.trackPageView(window.location.pathname, document.title, {
            article_title: articleTitle,
            article_tags: articleTags,
            reading_time: readingTime,
          });
        }
      });
    }

  </script>
  <CodeCopy />
  <ImageLightbox />
  <BackToTop />

  <!-- Styles for affiliate products -->
  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</Layout>
