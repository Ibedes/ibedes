<button
    id="back-to-top"
    class="fixed bottom-8 lg:bottom-8 left-8 lg:left-8 z-40 p-3 rounded-full bg-emerald-600 dark:bg-emerald-500 text-white shadow-lg hover:bg-emerald-700 dark:hover:bg-emerald-600 transition-all opacity-0 invisible translate-y-4"
    aria-label="Kembali ke atas"
>
    <i class="fa-solid fa-arrow-up text-xl"></i>
</button>

<script>
    function initBackToTop() {
        const backToTopBtn = document.getElementById("back-to-top");
        if (!backToTopBtn) return;

        const toggleButton = () => {
            // Check if comment popup is open
            const commentPopup = document.querySelector("[data-comment-popup]");
            const isCommentOpen =
                commentPopup && !commentPopup.hasAttribute("hidden");

            // Mirror floating engagement visibility: show after ~30% scroll
            const doc = document.documentElement;
            const scrollTop = doc.scrollTop || document.body.scrollTop || 0;
            const scrollHeight =
                doc.scrollHeight || document.body.scrollHeight || 0;
            const clientHeight = doc.clientHeight || window.innerHeight || 1;
            const maxScroll = Math.max(1, scrollHeight - clientHeight);
            const progress =
                scrollHeight <= clientHeight ? 1 : scrollTop / maxScroll;
            const shouldShow = progress >= 0.3;

            if (isCommentOpen) {
                // Hide button when comment popup is open
                backToTopBtn.classList.add(
                    "opacity-0",
                    "invisible",
                    "translate-y-4",
                );
                backToTopBtn.classList.remove(
                    "opacity-100",
                    "visible",
                    "translate-y-0",
                );
            } else if (shouldShow) {
                backToTopBtn.classList.remove(
                    "opacity-0",
                    "invisible",
                    "translate-y-4",
                );
                backToTopBtn.classList.add(
                    "opacity-100",
                    "visible",
                    "translate-y-0",
                );
            } else {
                backToTopBtn.classList.add(
                    "opacity-0",
                    "invisible",
                    "translate-y-4",
                );
                backToTopBtn.classList.remove(
                    "opacity-100",
                    "visible",
                    "translate-y-0",
                );
            }
        };

        const syncWithFloatingControls = () => {
            // Pin to left with same spacing as reaction FAB (2rem)
            backToTopBtn.style.left = "2rem";
            backToTopBtn.style.right = "auto";
            backToTopBtn.style.bottom = "2rem";
            backToTopBtn.style.zIndex = "41";
        };

        const scrollToTop = () => {
            window.scrollTo({
                top: 0,
                behavior: "smooth",
            });
        };

        window.addEventListener("scroll", toggleButton, { passive: true });
        backToTopBtn.addEventListener("click", scrollToTop);
        window.addEventListener("resize", syncWithFloatingControls);
        syncWithFloatingControls();

        // Watch for comment popup changes
        const observer = new MutationObserver(toggleButton);
        const commentPopup = document.querySelector("[data-comment-popup]");
        if (commentPopup) {
            observer.observe(commentPopup, {
                attributes: true,
                attributeFilter: ["hidden"],
            });
        }

        // Initial check
        toggleButton();
    }

    // Initialize on load and after view transitions
    document.addEventListener("DOMContentLoaded", initBackToTop);
    document.addEventListener("astro:page-load", initBackToTop);
</script>
