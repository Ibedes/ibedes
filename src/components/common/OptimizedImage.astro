---
// Optimized image component with lazy loading and blur placeholder
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

export interface Props {
    src: string | ImageMetadata;
    alt: string;
    width?: number;
    height?: number;
    class?: string;
    loading?: "lazy" | "eager";
    decoding?: "async" | "sync" | "auto";
    fetchpriority?: "high" | "low" | "auto";
    quality?: number;
    format?: "avif" | "webp" | "png" | "jpg";
}

const {
    src,
    alt,
    width,
    height,
    class: className,
    loading = "lazy",
    decoding = "async",
    fetchpriority = "auto",
    quality = 80,
    format = "webp",
} = Astro.props;

const isExternalImage =
    typeof src === "string" &&
    (src.startsWith("http://") || src.startsWith("https://"));
---

{
    isExternalImage ? (
        <img
            src={src as string}
            alt={alt}
            width={width}
            height={height}
            class:list={["optimized-image", className]}
            loading={loading}
            decoding={decoding}
            fetchpriority={fetchpriority}
        />
    ) : (
        <Image
            src={src}
            alt={alt}
            width={width}
            height={height}
            class:list={["optimized-image", className]}
            loading={loading}
            decoding={decoding}
            fetchpriority={fetchpriority}
            quality={quality}
            format={format}
        />
    )
}

<style>
    .optimized-image {
        /* Prevent layout shift */
        max-width: 100%;
        height: auto;

        /* Smooth loading */
        opacity: 0;
        animation: fade-in 0.3s ease-in forwards;
    }

    @keyframes fade-in {
        to {
            opacity: 1;
        }
    }

    /* Blur-up effect for lazy loaded images */
    .optimized-image[loading="lazy"] {
        background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.05),
            rgba(0, 0, 0, 0.1)
        );
    }

    .dark .optimized-image[loading="lazy"] {
        background: linear-gradient(
            to bottom,
            rgba(255, 255, 255, 0.05),
            rgba(255, 255, 255, 0.1)
        );
    }
</style>

<script>
    // Intersection Observer for lazy loading fallback
    if ("IntersectionObserver" in window) {
        const imageObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const img = entry.target as HTMLImageElement;

                        // Trigger load if not already loaded
                        if (!img.complete) {
                            img.src = img.src; // Force reload
                        }

                        imageObserver.unobserve(img);
                    }
                });
            },
            {
                rootMargin: "50px", // Start loading 50px before entering viewport
            },
        );

        // Observe all lazy images
        document.querySelectorAll('img[loading="lazy"]').forEach((img) => {
            imageObserver.observe(img);
        });
    }
</script>
