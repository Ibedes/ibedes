---
import ArticleSnippet from "./ArticleSnippet.astro";
import { articles as articleList } from "../lib/list";

interface Props {
    currentSlug: string;
    tags: string[];
}

const { currentSlug, tags } = Astro.props;

// Normalize article data from shared list (uses Supabase in prod, content collection in dev)
const allArticles = (articleList || []).map((article) => {
    const slug =
        article.filename?.split("/").filter(Boolean).pop() ??
        article.slug ??
        "";

    return {
        ...article,
        slug,
        url: article.filename || article.url || `/blog/${slug}`,
        tags: article.tags || [],
        timestamp: article.timestamp || article.pubDate || new Date().toISOString(),
    };
});

const relatedArticles = allArticles
    .filter((article) => article.slug !== currentSlug)
    .map((article) => {
        const matchingTags = article.tags.filter((tag: string) =>
            tags.includes(tag),
        );
        return {
            ...article,
            relevance: matchingTags.length,
        };
    })
    .filter((article) => article.relevance > 0)
    .sort(
        (a, b) =>
            b.relevance - a.relevance ||
            new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime(),
    )
    .slice(0, 3);

// Fallback to the latest articles if no tag-based matches are found
const articlesToShow =
    relatedArticles.length > 0
        ? relatedArticles
        : allArticles
              .filter((article) => article.slug !== currentSlug)
              .sort(
                  (a, b) =>
                      new Date(b.timestamp).getTime() -
                      new Date(a.timestamp).getTime(),
              )
              .slice(0, 3);
---

{
    articlesToShow.length > 0 && (
        <section class="border-t-2 border-dashed border-black/10 dark:border-white/10 pt-12 mt-12">
            <h2 class="font-display text-lg uppercase tracking-widest mb-8 flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-emerald-500" />
                Baca Juga
            </h2>
            <div class="grid gap-x-8 gap-y-12 sm:grid-cols-2 lg:grid-cols-3">
                {articlesToShow.map((article) => (
                    <div class="flex flex-col h-full">
                        <ArticleSnippet
                            title={article.title}
                            description={article.description}
                            url={article.url}
                            timestamp={article.timestamp}
                            duration={`${article.time || article.minutesRead || "5"} min read`}
                        />
                    </div>
                ))}
            </div>
        </section>
    )
}
