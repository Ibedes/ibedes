---
interface Props {
    title?: string;
    html?: string;
    css?: string;
    js?: string;
    height?: string;
    defaultTab?: "html" | "css" | "js";
    showPreview?: boolean;
}

const {
    title = "Code Playground",
    html = "",
    css = "",
    js = "",
    height = "500px",
    defaultTab = "html",
    showPreview = true,
} = Astro.props;

// Generate unique ID for this playground instance
const playgroundId = `playground-${Math.random().toString(36).substr(2, 9)}`;
---

<div
    class="code-playground"
    data-playground-id={playgroundId}
    style={`--playground-height: ${height}`}
>
    {title && <h3 class="playground-title">{title}</h3>}

    <div class="playground-container">
        <!-- Editor Section -->
        <div class="editor-section">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button
                    class="tab-btn active"
                    data-tab="html"
                    data-playground={playgroundId}
                >
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M4 4l3 3-3 3M8 12h8"></path>
                    </svg>
                    HTML
                </button>
                <button
                    class="tab-btn"
                    data-tab="css"
                    data-playground={playgroundId}
                >
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                        <path d="M7 7h10M7 12h10M7 17h10"></path>
                    </svg>
                    CSS
                </button>
                <button
                    class="tab-btn"
                    data-tab="js"
                    data-playground={playgroundId}
                >
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                    JavaScript
                </button>

                <div class="tab-actions">
                    <button
                        class="action-btn copy-btn"
                        title="Copy Code"
                        data-playground={playgroundId}
                    >
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <rect
                                x="9"
                                y="9"
                                width="13"
                                height="13"
                                rx="2"
                                ry="2"></rect>
                            <path
                                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                            ></path>
                        </svg>
                    </button>
                    <button
                        class="action-btn reset-btn"
                        title="Reset Code"
                        data-playground={playgroundId}
                    >
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"
                            ></path>
                            <path d="M21 3v5h-5"></path>
                        </svg>
                    </button>
                    <button
                        class="action-btn run-btn"
                        title="Run Code"
                        data-playground={playgroundId}
                    >
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Run
                    </button>
                </div>
            </div>

            <!-- Code Editors -->
            <div class="editors">
                <div
                    class="editor-pane active"
                    data-editor="html"
                    data-playground={playgroundId}
                >
                    <textarea
                        class="code-editor"
                        spellcheck="false"
                        data-language="html"
                        data-playground={playgroundId}>{html}</textarea
                    >
                </div>
                <div
                    class="editor-pane"
                    data-editor="css"
                    data-playground={playgroundId}
                >
                    <textarea
                        class="code-editor"
                        spellcheck="false"
                        data-language="css"
                        data-playground={playgroundId}>{css}</textarea
                    >
                </div>
                <div
                    class="editor-pane"
                    data-editor="js"
                    data-playground={playgroundId}
                >
                    <textarea
                        class="code-editor"
                        spellcheck="false"
                        data-language="js"
                        data-playground={playgroundId}>{js}</textarea
                    >
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        {
            showPreview && (
                <div class="preview-section">
                    <div class="preview-header">
                        <span class="preview-label">Preview</span>
                        <button
                            class="action-btn refresh-btn"
                            title="Refresh Preview"
                            data-playground={playgroundId}
                        >
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" />
                            </svg>
                        </button>
                    </div>
                    <iframe
                        class="preview-frame"
                        sandbox="allow-scripts allow-modals"
                        data-playground={playgroundId}
                    />
                </div>
            )
        }
    </div>
</div>

<style>
    .code-playground {
        margin: 2rem 0;
        border-radius: 12px;
        background: linear-gradient(
            135deg,
            rgba(255, 107, 107, 0.05),
            rgba(78, 205, 196, 0.05)
        );
        padding: 1.5rem;
        border: 1px solid rgba(255, 107, 107, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .playground-title {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .playground-title::before {
        content: "";
        width: 4px;
        height: 1.5rem;
        background: linear-gradient(180deg, #ff6b6b, #4ecdc4);
        border-radius: 2px;
    }

    .playground-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        background: var(--color-bg);
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(255, 107, 107, 0.1);
    }

    @media (max-width: 768px) {
        .playground-container {
            grid-template-columns: 1fr;
        }
    }

    .editor-section,
    .preview-section {
        display: flex;
        flex-direction: column;
        min-height: var(--playground-height);
    }

    /* Tab Navigation */
    .tab-nav {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid rgba(255, 107, 107, 0.2);
    }

    .tab-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .tab-btn:hover {
        background: rgba(255, 107, 107, 0.1);
        color: rgba(255, 255, 255, 0.9);
        border-color: rgba(255, 107, 107, 0.3);
    }

    .tab-btn.active {
        background: linear-gradient(
            135deg,
            rgba(255, 107, 107, 0.2),
            rgba(78, 205, 196, 0.2)
        );
        color: #fff;
        border-color: rgba(255, 107, 107, 0.5);
    }

    .tab-btn svg {
        width: 16px;
        height: 16px;
    }

    .tab-actions {
        margin-left: auto;
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 107, 107, 0.3);
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        background: rgba(255, 107, 107, 0.2);
        border-color: rgba(255, 107, 107, 0.5);
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }

    .action-btn:active {
        transform: translateY(0);
    }

    .run-btn {
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        border-color: transparent;
        color: #fff;
    }

    .run-btn:hover {
        background: linear-gradient(135deg, #ee5a6f, #ff6b6b);
        box-shadow: 0 4px 16px rgba(255, 107, 107, 0.5);
    }

    /* Editors */
    .editors {
        position: relative;
        flex: 1;
        background: #1e1e1e;
    }

    .editor-pane {
        display: none;
        height: 100%;
    }

    .editor-pane.active {
        display: block;
    }

    .code-editor {
        width: 100%;
        height: 100%;
        padding: 1rem;
        background: #1e1e1e;
        color: #d4d4d4;
        border: none;
        outline: none;
        font-family: "Fira Code", "Consolas", "Monaco", monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        resize: none;
        tab-size: 2;
    }

    .code-editor::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .code-editor::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
    }

    .code-editor::-webkit-scrollbar-thumb {
        background: rgba(255, 107, 107, 0.5);
        border-radius: 4px;
    }

    .code-editor::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 107, 107, 0.7);
    }

    /* Preview Section */
    .preview-section {
        background: #fff;
    }

    .preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.05);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .preview-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--color-text);
    }

    .preview-frame {
        flex: 1;
        width: 100%;
        border: none;
        background: #fff;
    }

    /* Copy Success Animation */
    @keyframes copySuccess {
        0%,
        100% {
            opacity: 0;
            transform: translateY(10px);
        }
        10%,
        90% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .copy-success {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #4ecdc4, #44a08d);
        color: #fff;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 8px 24px rgba(78, 205, 196, 0.4);
        animation: copySuccess 2s ease;
        z-index: 1000;
    }
</style>

<script>
    // Store original code for reset functionality
    const originalCode = new Map();

    document.addEventListener("DOMContentLoaded", () => {
        const playgrounds = document.querySelectorAll(".code-playground");

        playgrounds.forEach((playground) => {
            const playgroundId = playground.getAttribute("data-playground-id");

            // Store original code
            const htmlEditor = playground.querySelector(
                '[data-editor="html"] textarea',
            );
            const cssEditor = playground.querySelector(
                '[data-editor="css"] textarea',
            );
            const jsEditor = playground.querySelector(
                '[data-editor="js"] textarea',
            );

            originalCode.set(playgroundId, {
                html: htmlEditor?.value || "",
                css: cssEditor?.value || "",
                js: jsEditor?.value || "",
            });

            // Tab switching
            const tabBtns = playground.querySelectorAll(".tab-btn");
            const editorPanes = playground.querySelectorAll(".editor-pane");

            tabBtns.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const tab = btn.getAttribute("data-tab");

                    // Update active tab
                    tabBtns.forEach((b) => b.classList.remove("active"));
                    btn.classList.add("active");

                    // Update active editor
                    editorPanes.forEach((pane) => {
                        if (pane.getAttribute("data-editor") === tab) {
                            pane.classList.add("active");
                        } else {
                            pane.classList.remove("active");
                        }
                    });
                });
            });

            // Run code
            const runBtn = playground.querySelector(".run-btn");
            runBtn?.addEventListener("click", () => {
                runCode(playgroundId);
            });

            // Refresh preview
            const refreshBtn = playground.querySelector(".refresh-btn");
            refreshBtn?.addEventListener("click", () => {
                runCode(playgroundId);
            });

            // Reset code
            const resetBtn = playground.querySelector(".reset-btn");
            resetBtn?.addEventListener("click", () => {
                resetCode(playgroundId);
            });

            // Copy code
            const copyBtn = playground.querySelector(".copy-btn");
            copyBtn?.addEventListener("click", () => {
                copyCode(playgroundId);
            });

            // Auto-run on load
            setTimeout(() => runCode(playgroundId), 100);
        });
    });

    function runCode(playgroundId: string) {
        const playground = document.querySelector(
            `[data-playground-id="${playgroundId}"]`,
        );
        if (!playground) return;

        const htmlEditor = playground.querySelector(
            '[data-editor="html"] textarea',
        ) as HTMLTextAreaElement;
        const cssEditor = playground.querySelector(
            '[data-editor="css"] textarea',
        ) as HTMLTextAreaElement;
        const jsEditor = playground.querySelector(
            '[data-editor="js"] textarea',
        ) as HTMLTextAreaElement;
        const iframe = playground.querySelector(
            ".preview-frame",
        ) as HTMLIFrameElement;

        if (!iframe) return;

        const html = htmlEditor?.value || "";
        const css = cssEditor?.value || "";
        const js = jsEditor?.value || "";

        const content = `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: system-ui, -apple-system, sans-serif; padding: 1rem; }
            ${css}
          </style>
        </head>
        <body>
          ${html}
          <script>
            try {
              ${js}
            } catch (error) {
              document.body.innerHTML = '<div style="color: red; padding: 1rem; background: #fee; border-radius: 4px; margin: 1rem 0;"><strong>Error:</strong> ' + error.message + '</div>' + document.body.innerHTML;
            }
          <\/script>
        </body>
      </html>
    `;

        iframe.srcdoc = content;
    }

    function resetCode(playgroundId: string) {
        const playground = document.querySelector(
            `[data-playground-id="${playgroundId}"]`,
        );
        if (!playground) return;

        const original = originalCode.get(playgroundId);
        if (!original) return;

        const htmlEditor = playground.querySelector(
            '[data-editor="html"] textarea',
        ) as HTMLTextAreaElement;
        const cssEditor = playground.querySelector(
            '[data-editor="css"] textarea',
        ) as HTMLTextAreaElement;
        const jsEditor = playground.querySelector(
            '[data-editor="js"] textarea',
        ) as HTMLTextAreaElement;

        if (htmlEditor) htmlEditor.value = original.html;
        if (cssEditor) cssEditor.value = original.css;
        if (jsEditor) jsEditor.value = original.js;

        runCode(playgroundId);
    }

    function copyCode(playgroundId: string) {
        const playground = document.querySelector(
            `[data-playground-id="${playgroundId}"]`,
        );
        if (!playground) return;

        const activePane = playground.querySelector(".editor-pane.active");
        const textarea = activePane?.querySelector(
            "textarea",
        ) as HTMLTextAreaElement;

        if (!textarea) return;

        textarea.select();
        document.execCommand("copy");

        // Show success message
        const successMsg = document.createElement("div");
        successMsg.className = "copy-success";
        successMsg.textContent = "âœ“ Code copied to clipboard!";
        document.body.appendChild(successMsg);

        setTimeout(() => {
            successMsg.remove();
        }, 2000);
    }
</script>
